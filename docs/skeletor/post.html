<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>skeletor.post API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../skeletor.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;skeletor</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#radii">radii</a>
            </li>
            <li>
                    <a class="function" href="#clean_up">clean_up</a>
            </li>
            <li>
                    <a class="function" href="#smooth">smooth</a>
            </li>
            <li>
                    <a class="function" href="#despike">despike</a>
            </li>
            <li>
                    <a class="function" href="#remove_bristles">remove_bristles</a>
            </li>
            <li>
                    <a class="function" href="#recenter_vertices">recenter_vertices</a>
            </li>
            <li>
                    <a class="function" href="#fix_outside_edges">fix_outside_edges</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../skeletor.html">skeletor</a><wbr>.post    </h1>

                        <div class="docstring"><p>The <code><a href="">skeletor.post</a></code> module contains functions to post-process skeletons after
skeletonization.</p>

<h3 id="fixing-issues-with-skeletons">Fixing issues with skeletons</h3>

<p>Depending on your mesh, pre-processing and the parameters you chose for
skeletonization, chances are that your skeleton will not come out perfectly.</p>

<p><code><a href="#clean_up">skeletor.post.clean_up</a></code> can help you solve some potential issues:</p>

<ul>
<li>skeleton nodes (vertices) that outside or right on the surface instead of
centered inside the mesh</li>
<li>superfluous "hairs" on otherwise straight bits</li>
</ul>

<p><code><a href="#smooth">skeletor.post.smooth</a></code> will smooth out the skeleton.</p>

<p><code><a href="#despike">skeletor.post.despike</a></code> can help you remove spikes in the skeleton where
single nodes are out of aligment.</p>

<p><code><a href="#remove_bristles">skeletor.post.remove_bristles</a></code> will remove bristles from the skeleton.</p>

<h3 id="computing-radius-information">Computing radius information</h3>

<p>Only <code><a href="skeletonize.html#by_wavefront">skeletor.skeletonize.by_wavefront()</a></code> provides radii off the bat. For all
other methods, you might want to run <code><a href="#radii">skeletor.post.radii</a></code> can help you
(re-)generate radius information for the skeletons.</p>
</div>

                        <input id="mod-post-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-post-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="c1">#    This script is part of skeletor (http://www.github.com/navis-org/skeletor).</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a><span class="c1">#    Copyright (C) 2018 Philipp Schlegel</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="c1">#</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a><span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a><span class="c1">#    it under the terms of the GNU General Public License as published by</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a><span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a><span class="c1">#    (at your option) any later version.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a><span class="c1">#</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a><span class="c1">#    This program is distributed in the hope that it will be useful,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a><span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a><span class="c1">#    GNU General Public License for more details.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a><span class="c1">#</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a><span class="c1">#    You should have received a copy of the GNU General Public License</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a><span class="c1">#    along with this program.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a><span class="sd">The `skeletor.post` module contains functions to post-process skeletons after</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a><span class="sd">skeletonization.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a><span class="sd">### Fixing issues with skeletons</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">23</span></a><span class="sd">Depending on your mesh, pre-processing and the parameters you chose for</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">24</span></a><span class="sd">skeletonization, chances are that your skeleton will not come out perfectly.</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">26</span></a><span class="sd">`skeletor.post.clean_up` can help you solve some potential issues:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">28</span></a><span class="sd">- skeleton nodes (vertices) that outside or right on the surface instead of</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">29</span></a><span class="sd">  centered inside the mesh</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">30</span></a><span class="sd">- superfluous &quot;hairs&quot; on otherwise straight bits</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">32</span></a><span class="sd">`skeletor.post.smooth` will smooth out the skeleton.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">34</span></a><span class="sd">`skeletor.post.despike` can help you remove spikes in the skeleton where</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">35</span></a><span class="sd">single nodes are out of aligment.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">37</span></a><span class="sd">`skeletor.post.remove_bristles` will remove bristles from the skeleton.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">39</span></a><span class="sd">### Computing radius information</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">41</span></a><span class="sd">Only `skeletor.skeletonize.by_wavefront()` provides radii off the bat. For all</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">42</span></a><span class="sd">other methods, you might want to run `skeletor.post.radii` can help you</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">43</span></a><span class="sd">(re-)generate radius information for the skeletons.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">45</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">47</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.radiusextraction</span><span class="w"> </span><span class="kn">import</span> <span class="n">radii</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">48</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.postprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">clean_up</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="n">despike</span><span class="p">,</span> <span class="n">remove_bristles</span><span class="p">,</span> <span class="n">recenter_vertices</span><span class="p">,</span> <span class="n">fix_outside_edges</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos">50</span></a><span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;numpy&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">51</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="s2">&quot;clean_up&quot;</span><span class="p">,</span> <span class="s2">&quot;smooth&quot;</span><span class="p">,</span> <span class="s2">&quot;despike&quot;</span><span class="p">,</span> <span class="s2">&quot;remove_bristles&quot;</span><span class="p">,</span> <span class="s2">&quot;recenter_vertices&quot;</span><span class="p">,</span> <span class="s2">&quot;fix_outside_edges&quot;</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="radii">
                            <input id="radii-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">radii</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">s</span>,</span><span class="param">	<span class="n">mesh</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">method</span><span class="o">=</span><span class="s1">&#39;knn&#39;</span>,</span><span class="param">	<span class="n">aggregate</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span>,</span><span class="param">	<span class="n">validate</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="radii-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#radii"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="radii-29"><a href="#radii-29"><span class="linenos"> 29</span></a><span class="k">def</span><span class="w"> </span><span class="nf">radii</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;knn&#39;</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="radii-30"><a href="#radii-30"><span class="linenos"> 30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract radii for given skeleton table.</span>
</span><span id="radii-31"><a href="#radii-31"><span class="linenos"> 31</span></a>
</span><span id="radii-32"><a href="#radii-32"><span class="linenos"> 32</span></a><span class="sd">    Important</span>
</span><span id="radii-33"><a href="#radii-33"><span class="linenos"> 33</span></a><span class="sd">    ---------</span>
</span><span id="radii-34"><a href="#radii-34"><span class="linenos"> 34</span></a><span class="sd">    This function really only produces useful radii if the skeleton is centered</span>
</span><span id="radii-35"><a href="#radii-35"><span class="linenos"> 35</span></a><span class="sd">    inside the mesh. `by_wavefront` does that by default whereas all other</span>
</span><span id="radii-36"><a href="#radii-36"><span class="linenos"> 36</span></a><span class="sd">    skeletonization methods don&#39;t. Your best bet to get centered skeletons is</span>
</span><span id="radii-37"><a href="#radii-37"><span class="linenos"> 37</span></a><span class="sd">    to contract the mesh first (`sk.pre.contract`).</span>
</span><span id="radii-38"><a href="#radii-38"><span class="linenos"> 38</span></a>
</span><span id="radii-39"><a href="#radii-39"><span class="linenos"> 39</span></a><span class="sd">    Parameters</span>
</span><span id="radii-40"><a href="#radii-40"><span class="linenos"> 40</span></a><span class="sd">    ----------</span>
</span><span id="radii-41"><a href="#radii-41"><span class="linenos"> 41</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="radii-42"><a href="#radii-42"><span class="linenos"> 42</span></a><span class="sd">                Skeleton to clean up.</span>
</span><span id="radii-43"><a href="#radii-43"><span class="linenos"> 43</span></a><span class="sd">    mesh :      trimesh.Trimesh, optional</span>
</span><span id="radii-44"><a href="#radii-44"><span class="linenos"> 44</span></a><span class="sd">                Original mesh (e.g. before contraction). If not provided will</span>
</span><span id="radii-45"><a href="#radii-45"><span class="linenos"> 45</span></a><span class="sd">                use the mesh associated with ``s``.</span>
</span><span id="radii-46"><a href="#radii-46"><span class="linenos"> 46</span></a><span class="sd">    method :    &quot;knn&quot; | &quot;ray&quot;</span>
</span><span id="radii-47"><a href="#radii-47"><span class="linenos"> 47</span></a><span class="sd">                Whether and how to add radius information to each node::</span>
</span><span id="radii-48"><a href="#radii-48"><span class="linenos"> 48</span></a>
</span><span id="radii-49"><a href="#radii-49"><span class="linenos"> 49</span></a><span class="sd">                    - &quot;knn&quot; uses k-nearest-neighbors to get radii: fast but</span>
</span><span id="radii-50"><a href="#radii-50"><span class="linenos"> 50</span></a><span class="sd">                      potential for being very wrong</span>
</span><span id="radii-51"><a href="#radii-51"><span class="linenos"> 51</span></a><span class="sd">                    - &quot;ray&quot; uses ray-casting to get radii: slower but sometimes</span>
</span><span id="radii-52"><a href="#radii-52"><span class="linenos"> 52</span></a><span class="sd">                      less wrong</span>
</span><span id="radii-53"><a href="#radii-53"><span class="linenos"> 53</span></a>
</span><span id="radii-54"><a href="#radii-54"><span class="linenos"> 54</span></a><span class="sd">    aggregate : &quot;mean&quot; | &quot;median&quot; | &quot;max&quot; | &quot;min&quot; | &quot;percentile75&quot;</span>
</span><span id="radii-55"><a href="#radii-55"><span class="linenos"> 55</span></a><span class="sd">                Function used to aggregate radii over sample (i.e. across</span>
</span><span id="radii-56"><a href="#radii-56"><span class="linenos"> 56</span></a><span class="sd">                k nearest-neighbors or ray intersections)</span>
</span><span id="radii-57"><a href="#radii-57"><span class="linenos"> 57</span></a><span class="sd">    validate :  bool</span>
</span><span id="radii-58"><a href="#radii-58"><span class="linenos"> 58</span></a><span class="sd">                If True, will try to fix potential issues with the mesh</span>
</span><span id="radii-59"><a href="#radii-59"><span class="linenos"> 59</span></a><span class="sd">                (e.g. infinite values, duplicate vertices, degenerate faces)</span>
</span><span id="radii-60"><a href="#radii-60"><span class="linenos"> 60</span></a><span class="sd">                before skeletonization. Note that this might make changes to</span>
</span><span id="radii-61"><a href="#radii-61"><span class="linenos"> 61</span></a><span class="sd">                your mesh inplace!</span>
</span><span id="radii-62"><a href="#radii-62"><span class="linenos"> 62</span></a><span class="sd">    **kwargs</span>
</span><span id="radii-63"><a href="#radii-63"><span class="linenos"> 63</span></a><span class="sd">                Keyword arguments are passed to the respective method:</span>
</span><span id="radii-64"><a href="#radii-64"><span class="linenos"> 64</span></a>
</span><span id="radii-65"><a href="#radii-65"><span class="linenos"> 65</span></a><span class="sd">                For method &quot;knn&quot;::</span>
</span><span id="radii-66"><a href="#radii-66"><span class="linenos"> 66</span></a>
</span><span id="radii-67"><a href="#radii-67"><span class="linenos"> 67</span></a><span class="sd">                    n :             int (default 5)</span>
</span><span id="radii-68"><a href="#radii-68"><span class="linenos"> 68</span></a><span class="sd">                                    Radius will be the mean over n nearest-neighbors.</span>
</span><span id="radii-69"><a href="#radii-69"><span class="linenos"> 69</span></a>
</span><span id="radii-70"><a href="#radii-70"><span class="linenos"> 70</span></a><span class="sd">                For method &quot;ray&quot;::</span>
</span><span id="radii-71"><a href="#radii-71"><span class="linenos"> 71</span></a>
</span><span id="radii-72"><a href="#radii-72"><span class="linenos"> 72</span></a><span class="sd">                    n_rays :        int (default 20)</span>
</span><span id="radii-73"><a href="#radii-73"><span class="linenos"> 73</span></a><span class="sd">                                    Number of rays to cast for each node.</span>
</span><span id="radii-74"><a href="#radii-74"><span class="linenos"> 74</span></a><span class="sd">                    projection :    &quot;sphere&quot; (default) | &quot;tangents&quot;</span>
</span><span id="radii-75"><a href="#radii-75"><span class="linenos"> 75</span></a><span class="sd">                                    Whether to cast rays in a sphere around each node or in a</span>
</span><span id="radii-76"><a href="#radii-76"><span class="linenos"> 76</span></a><span class="sd">                                    circle orthogonally to the node&#39;s tangent vector.</span>
</span><span id="radii-77"><a href="#radii-77"><span class="linenos"> 77</span></a><span class="sd">                    fallback :      &quot;knn&quot; (default) | None | number</span>
</span><span id="radii-78"><a href="#radii-78"><span class="linenos"> 78</span></a><span class="sd">                                    If a point is outside or right on the surface of the mesh</span>
</span><span id="radii-79"><a href="#radii-79"><span class="linenos"> 79</span></a><span class="sd">                                    the raycasting will return nonesense results. We can either</span>
</span><span id="radii-80"><a href="#radii-80"><span class="linenos"> 80</span></a><span class="sd">                                    ignore those cases (``None``), assign a arbitrary number or</span>
</span><span id="radii-81"><a href="#radii-81"><span class="linenos"> 81</span></a><span class="sd">                                    we can fall back to radii from k-nearest-neighbors (``knn``).</span>
</span><span id="radii-82"><a href="#radii-82"><span class="linenos"> 82</span></a>
</span><span id="radii-83"><a href="#radii-83"><span class="linenos"> 83</span></a><span class="sd">    Returns</span>
</span><span id="radii-84"><a href="#radii-84"><span class="linenos"> 84</span></a><span class="sd">    -------</span>
</span><span id="radii-85"><a href="#radii-85"><span class="linenos"> 85</span></a><span class="sd">    None</span>
</span><span id="radii-86"><a href="#radii-86"><span class="linenos"> 86</span></a><span class="sd">                    But attaches `radius` to the skeleton&#39;s SWC table. Existing</span>
</span><span id="radii-87"><a href="#radii-87"><span class="linenos"> 87</span></a><span class="sd">                    values are replaced!</span>
</span><span id="radii-88"><a href="#radii-88"><span class="linenos"> 88</span></a>
</span><span id="radii-89"><a href="#radii-89"><span class="linenos"> 89</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="radii-90"><a href="#radii-90"><span class="linenos"> 90</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="radii-91"><a href="#radii-91"><span class="linenos"> 91</span></a>        <span class="n">mesh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="radii-92"><a href="#radii-92"><span class="linenos"> 92</span></a>
</span><span id="radii-93"><a href="#radii-93"><span class="linenos"> 93</span></a>    <span class="n">mesh</span> <span class="o">=</span> <span class="n">make_trimesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="radii-94"><a href="#radii-94"><span class="linenos"> 94</span></a>
</span><span id="radii-95"><a href="#radii-95"><span class="linenos"> 95</span></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;knn&#39;</span><span class="p">:</span>
</span><span id="radii-96"><a href="#radii-96"><span class="linenos"> 96</span></a>        <span class="n">radius</span> <span class="o">=</span> <span class="n">get_radius_knn</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="radii-97"><a href="#radii-97"><span class="linenos"> 97</span></a>                                <span class="n">aggregate</span><span class="o">=</span><span class="n">aggregate</span><span class="p">,</span>
</span><span id="radii-98"><a href="#radii-98"><span class="linenos"> 98</span></a>                                <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="radii-99"><a href="#radii-99"><span class="linenos"> 99</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ray&#39;</span><span class="p">:</span>
</span><span id="radii-100"><a href="#radii-100"><span class="linenos">100</span></a>        <span class="n">radius</span> <span class="o">=</span> <span class="n">get_radius_ray</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">,</span>
</span><span id="radii-101"><a href="#radii-101"><span class="linenos">101</span></a>                                <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="radii-102"><a href="#radii-102"><span class="linenos">102</span></a>                                <span class="n">aggregate</span><span class="o">=</span><span class="n">aggregate</span><span class="p">,</span>
</span><span id="radii-103"><a href="#radii-103"><span class="linenos">103</span></a>                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="radii-104"><a href="#radii-104"><span class="linenos">104</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="radii-105"><a href="#radii-105"><span class="linenos">105</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown method &quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
</span><span id="radii-106"><a href="#radii-106"><span class="linenos">106</span></a>
</span><span id="radii-107"><a href="#radii-107"><span class="linenos">107</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
</span><span id="radii-108"><a href="#radii-108"><span class="linenos">108</span></a>
</span><span id="radii-109"><a href="#radii-109"><span class="linenos">109</span></a>    <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Extract radii for given skeleton table.</p>

<h6 id="important">Important</h6>

<p>This function really only produces useful radii if the skeleton is centered
inside the mesh. <code>by_wavefront</code> does that by default whereas all other
skeletonization methods don't. Your best bet to get centered skeletons is
to contract the mesh first (<code>sk.pre.contract</code>).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton to clean up.</li>
<li><strong>mesh</strong> (trimesh.Trimesh, optional):
Original mesh (e.g. before contraction). If not provided will
use the mesh associated with <code>s</code>.</li>
<li><p><strong>method</strong> ("knn" | "ray"):
Whether and how to add radius information to each node::</p>

<pre><code>- "knn" uses k-nearest-neighbors to get radii: fast but
  potential for being very wrong
- "ray" uses ray-casting to get radii: slower but sometimes
  less wrong
</code></pre></li>
<li><strong>aggregate</strong> ("mean" | "median" | "max" | "min" | "percentile75"):
Function used to aggregate radii over sample (i.e. across
k nearest-neighbors or ray intersections)</li>
<li><strong>validate</strong> (bool):
If True, will try to fix potential issues with the mesh
(e.g. infinite values, duplicate vertices, degenerate faces)
before skeletonization. Note that this might make changes to
your mesh inplace!</li>
<li><strong>**kwargs</strong>: Keyword arguments are passed to the respective method:</li>
</ul>

<p>For method "knn"::</p>

<pre><code>n :             int (default 5)
                Radius will be the mean over n nearest-neighbors.
</code></pre>

<p>For method "ray"::</p>

<pre><code>n_rays :        int (default 20)
                Number of rays to cast for each node.
projection :    "sphere" (default) | "tangents"
                Whether to cast rays in a sphere around each node or in a
                circle orthogonally to the node's tangent vector.
fallback :      "knn" (default) | None | number
                If a point is outside or right on the surface of the mesh
                the raycasting will return nonesense results. We can either
                ignore those cases (``None``), assign a arbitrary number or
                we can fall back to radii from k-nearest-neighbors (``knn``).
</code></pre>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong>: But attaches <code>radius</code> to the skeleton's SWC table. Existing
values are replaced!</li>
</ul>
</div>


                </section>
                <section id="clean_up">
                            <input id="clean_up-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clean_up</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">mesh</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">validate</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="clean_up-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#clean_up"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="clean_up-30"><a href="#clean_up-30"><span class="linenos">30</span></a><span class="k">def</span><span class="w"> </span><span class="nf">clean_up</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="clean_up-31"><a href="#clean_up-31"><span class="linenos">31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up the skeleton.</span>
</span><span id="clean_up-32"><a href="#clean_up-32"><span class="linenos">32</span></a>
</span><span id="clean_up-33"><a href="#clean_up-33"><span class="linenos">33</span></a><span class="sd">    This function bundles a bunch of procedures to clean up the skeleton:</span>
</span><span id="clean_up-34"><a href="#clean_up-34"><span class="linenos">34</span></a>
</span><span id="clean_up-35"><a href="#clean_up-35"><span class="linenos">35</span></a><span class="sd">      1. Remove twigs that are running parallel to their parent branch</span>
</span><span id="clean_up-36"><a href="#clean_up-36"><span class="linenos">36</span></a><span class="sd">      2. Move nodes outside the mesh back inside (or at least snap to surface)</span>
</span><span id="clean_up-37"><a href="#clean_up-37"><span class="linenos">37</span></a>
</span><span id="clean_up-38"><a href="#clean_up-38"><span class="linenos">38</span></a><span class="sd">    Note that this is not a magic bullet and some of this will not work (well)</span>
</span><span id="clean_up-39"><a href="#clean_up-39"><span class="linenos">39</span></a><span class="sd">    if the original mesh was degenerate (e.g. internal faces or not watertight)</span>
</span><span id="clean_up-40"><a href="#clean_up-40"><span class="linenos">40</span></a><span class="sd">    to begin with.</span>
</span><span id="clean_up-41"><a href="#clean_up-41"><span class="linenos">41</span></a>
</span><span id="clean_up-42"><a href="#clean_up-42"><span class="linenos">42</span></a><span class="sd">    Parameters</span>
</span><span id="clean_up-43"><a href="#clean_up-43"><span class="linenos">43</span></a><span class="sd">    ----------</span>
</span><span id="clean_up-44"><a href="#clean_up-44"><span class="linenos">44</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="clean_up-45"><a href="#clean_up-45"><span class="linenos">45</span></a><span class="sd">                Skeleton to clean up.</span>
</span><span id="clean_up-46"><a href="#clean_up-46"><span class="linenos">46</span></a><span class="sd">    mesh :      trimesh.Trimesh, optional</span>
</span><span id="clean_up-47"><a href="#clean_up-47"><span class="linenos">47</span></a><span class="sd">                Original mesh (e.g. before contraction). If not provided will</span>
</span><span id="clean_up-48"><a href="#clean_up-48"><span class="linenos">48</span></a><span class="sd">                use the mesh associated with ``s``.</span>
</span><span id="clean_up-49"><a href="#clean_up-49"><span class="linenos">49</span></a><span class="sd">    validate :  bool</span>
</span><span id="clean_up-50"><a href="#clean_up-50"><span class="linenos">50</span></a><span class="sd">                If True, will try to fix potential issues with the mesh</span>
</span><span id="clean_up-51"><a href="#clean_up-51"><span class="linenos">51</span></a><span class="sd">                (e.g. infinite values, duplicate vertices, degenerate faces)</span>
</span><span id="clean_up-52"><a href="#clean_up-52"><span class="linenos">52</span></a><span class="sd">                before cleaning up. Note that this might change your mesh</span>
</span><span id="clean_up-53"><a href="#clean_up-53"><span class="linenos">53</span></a><span class="sd">                inplace!</span>
</span><span id="clean_up-54"><a href="#clean_up-54"><span class="linenos">54</span></a><span class="sd">    inplace :   bool</span>
</span><span id="clean_up-55"><a href="#clean_up-55"><span class="linenos">55</span></a><span class="sd">                If False will make and return a copy of the skeleton. If True,</span>
</span><span id="clean_up-56"><a href="#clean_up-56"><span class="linenos">56</span></a><span class="sd">                will modify the `s` inplace.</span>
</span><span id="clean_up-57"><a href="#clean_up-57"><span class="linenos">57</span></a>
</span><span id="clean_up-58"><a href="#clean_up-58"><span class="linenos">58</span></a><span class="sd">    **kwargs</span>
</span><span id="clean_up-59"><a href="#clean_up-59"><span class="linenos">59</span></a><span class="sd">                Keyword arguments are passed to the bundled function.</span>
</span><span id="clean_up-60"><a href="#clean_up-60"><span class="linenos">60</span></a>
</span><span id="clean_up-61"><a href="#clean_up-61"><span class="linenos">61</span></a><span class="sd">                For `skeletor.postprocessing.drop_parallel_twigs`::</span>
</span><span id="clean_up-62"><a href="#clean_up-62"><span class="linenos">62</span></a>
</span><span id="clean_up-63"><a href="#clean_up-63"><span class="linenos">63</span></a><span class="sd">                 theta :     float (default 0.01)</span>
</span><span id="clean_up-64"><a href="#clean_up-64"><span class="linenos">64</span></a><span class="sd">                             For each twig we generate the dotproduct between the tangent</span>
</span><span id="clean_up-65"><a href="#clean_up-65"><span class="linenos">65</span></a><span class="sd">                             vectors of it and its parents. If these line up perfectly the</span>
</span><span id="clean_up-66"><a href="#clean_up-66"><span class="linenos">66</span></a><span class="sd">                             dotproduct will equal 1. ``theta`` determines how much that</span>
</span><span id="clean_up-67"><a href="#clean_up-67"><span class="linenos">67</span></a><span class="sd">                             value can differ from 1 for us to still prune the twig: higher</span>
</span><span id="clean_up-68"><a href="#clean_up-68"><span class="linenos">68</span></a><span class="sd">                             theta = more pruning.</span>
</span><span id="clean_up-69"><a href="#clean_up-69"><span class="linenos">69</span></a>
</span><span id="clean_up-70"><a href="#clean_up-70"><span class="linenos">70</span></a><span class="sd">    Returns</span>
</span><span id="clean_up-71"><a href="#clean_up-71"><span class="linenos">71</span></a><span class="sd">    -------</span>
</span><span id="clean_up-72"><a href="#clean_up-72"><span class="linenos">72</span></a><span class="sd">    s_clean :   skeletor.Skeleton</span>
</span><span id="clean_up-73"><a href="#clean_up-73"><span class="linenos">73</span></a><span class="sd">                Hopefully improved skeleton.</span>
</span><span id="clean_up-74"><a href="#clean_up-74"><span class="linenos">74</span></a>
</span><span id="clean_up-75"><a href="#clean_up-75"><span class="linenos">75</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="clean_up-76"><a href="#clean_up-76"><span class="linenos">76</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="clean_up-77"><a href="#clean_up-77"><span class="linenos">77</span></a>        <span class="n">mesh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="clean_up-78"><a href="#clean_up-78"><span class="linenos">78</span></a>
</span><span id="clean_up-79"><a href="#clean_up-79"><span class="linenos">79</span></a>    <span class="n">mesh</span> <span class="o">=</span> <span class="n">make_trimesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
</span><span id="clean_up-80"><a href="#clean_up-80"><span class="linenos">80</span></a>
</span><span id="clean_up-81"><a href="#clean_up-81"><span class="linenos">81</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="clean_up-82"><a href="#clean_up-82"><span class="linenos">82</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="clean_up-83"><a href="#clean_up-83"><span class="linenos">83</span></a>
</span><span id="clean_up-84"><a href="#clean_up-84"><span class="linenos">84</span></a>    <span class="c1"># Drop parallel twigs</span>
</span><span id="clean_up-85"><a href="#clean_up-85"><span class="linenos">85</span></a>    <span class="n">_</span> <span class="o">=</span> <span class="n">drop_parallel_twigs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="clean_up-86"><a href="#clean_up-86"><span class="linenos">86</span></a>
</span><span id="clean_up-87"><a href="#clean_up-87"><span class="linenos">87</span></a>    <span class="c1"># Recenter vertices</span>
</span><span id="clean_up-88"><a href="#clean_up-88"><span class="linenos">88</span></a>    <span class="n">_</span> <span class="o">=</span> <span class="n">recenter_vertices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="clean_up-89"><a href="#clean_up-89"><span class="linenos">89</span></a>
</span><span id="clean_up-90"><a href="#clean_up-90"><span class="linenos">90</span></a>    <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Clean up the skeleton.</p>

<p>This function bundles a bunch of procedures to clean up the skeleton:</p>

<ol>
<li>Remove twigs that are running parallel to their parent branch</li>
<li>Move nodes outside the mesh back inside (or at least snap to surface)</li>
</ol>

<p>Note that this is not a magic bullet and some of this will not work (well)
if the original mesh was degenerate (e.g. internal faces or not watertight)
to begin with.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton to clean up.</li>
<li><strong>mesh</strong> (trimesh.Trimesh, optional):
Original mesh (e.g. before contraction). If not provided will
use the mesh associated with <code>s</code>.</li>
<li><strong>validate</strong> (bool):
If True, will try to fix potential issues with the mesh
(e.g. infinite values, duplicate vertices, degenerate faces)
before cleaning up. Note that this might change your mesh
inplace!</li>
<li><strong>inplace</strong> (bool):
If False will make and return a copy of the skeleton. If True,
will modify the <code>s</code> inplace.</li>
<li><strong>**kwargs</strong>: Keyword arguments are passed to the bundled function.</li>
</ul>

<p>For <code>skeletor.postprocessing.drop_parallel_twigs</code>::</p>

<p>theta :     float (default 0.01)
             For each twig we generate the dotproduct between the tangent
             vectors of it and its parents. If these line up perfectly the
             dotproduct will equal 1. <code>theta</code> determines how much that
             value can differ from 1 for us to still prune the twig: higher
             theta = more pruning.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s_clean</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Hopefully improved skeleton.</li>
</ul>
</div>


                </section>
                <section id="smooth">
                            <input id="smooth-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">smooth</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">s</span>,</span><span class="param">	<span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">to_smooth</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="smooth-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#smooth"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="smooth-839"><a href="#smooth-839"><span class="linenos">839</span></a><span class="k">def</span><span class="w"> </span><span class="nf">smooth</span><span class="p">(</span>
</span><span id="smooth-840"><a href="#smooth-840"><span class="linenos">840</span></a>    <span class="n">s</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">to_smooth</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="smooth-841"><a href="#smooth-841"><span class="linenos">841</span></a><span class="p">):</span>
</span><span id="smooth-842"><a href="#smooth-842"><span class="linenos">842</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Smooth skeleton using rolling windows.</span>
</span><span id="smooth-843"><a href="#smooth-843"><span class="linenos">843</span></a>
</span><span id="smooth-844"><a href="#smooth-844"><span class="linenos">844</span></a><span class="sd">    Parameters</span>
</span><span id="smooth-845"><a href="#smooth-845"><span class="linenos">845</span></a><span class="sd">    ----------</span>
</span><span id="smooth-846"><a href="#smooth-846"><span class="linenos">846</span></a><span class="sd">    s :             skeletor.Skeleton</span>
</span><span id="smooth-847"><a href="#smooth-847"><span class="linenos">847</span></a><span class="sd">                    Skeleton to be processed.</span>
</span><span id="smooth-848"><a href="#smooth-848"><span class="linenos">848</span></a><span class="sd">    window :        int, optional</span>
</span><span id="smooth-849"><a href="#smooth-849"><span class="linenos">849</span></a><span class="sd">                    Size (N observations) of the rolling window in number of</span>
</span><span id="smooth-850"><a href="#smooth-850"><span class="linenos">850</span></a><span class="sd">                    nodes.</span>
</span><span id="smooth-851"><a href="#smooth-851"><span class="linenos">851</span></a><span class="sd">    to_smooth :     list</span>
</span><span id="smooth-852"><a href="#smooth-852"><span class="linenos">852</span></a><span class="sd">                    Columns of the node table to smooth. Should work with any</span>
</span><span id="smooth-853"><a href="#smooth-853"><span class="linenos">853</span></a><span class="sd">                    numeric column (e.g. &#39;radius&#39;).</span>
</span><span id="smooth-854"><a href="#smooth-854"><span class="linenos">854</span></a><span class="sd">    inplace :       bool</span>
</span><span id="smooth-855"><a href="#smooth-855"><span class="linenos">855</span></a><span class="sd">                    If False will make and return a copy of the skeleton. If</span>
</span><span id="smooth-856"><a href="#smooth-856"><span class="linenos">856</span></a><span class="sd">                    True, will modify the `s` inplace.</span>
</span><span id="smooth-857"><a href="#smooth-857"><span class="linenos">857</span></a>
</span><span id="smooth-858"><a href="#smooth-858"><span class="linenos">858</span></a><span class="sd">    Returns</span>
</span><span id="smooth-859"><a href="#smooth-859"><span class="linenos">859</span></a><span class="sd">    -------</span>
</span><span id="smooth-860"><a href="#smooth-860"><span class="linenos">860</span></a><span class="sd">    s :             skeletor.Skeleton</span>
</span><span id="smooth-861"><a href="#smooth-861"><span class="linenos">861</span></a><span class="sd">                    Skeleton with smoothed node table.</span>
</span><span id="smooth-862"><a href="#smooth-862"><span class="linenos">862</span></a>
</span><span id="smooth-863"><a href="#smooth-863"><span class="linenos">863</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="smooth-864"><a href="#smooth-864"><span class="linenos">864</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="smooth-865"><a href="#smooth-865"><span class="linenos">865</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="smooth-866"><a href="#smooth-866"><span class="linenos">866</span></a>
</span><span id="smooth-867"><a href="#smooth-867"><span class="linenos">867</span></a>    <span class="c1"># Prepare nodes (add parent_dist for later, set index)</span>
</span><span id="smooth-868"><a href="#smooth-868"><span class="linenos">868</span></a>    <span class="n">nodes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="smooth-869"><a href="#smooth-869"><span class="linenos">869</span></a>
</span><span id="smooth-870"><a href="#smooth-870"><span class="linenos">870</span></a>    <span class="n">to_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_smooth</span><span class="p">)</span>
</span><span id="smooth-871"><a href="#smooth-871"><span class="linenos">871</span></a>    <span class="n">miss</span> <span class="o">=</span> <span class="n">to_smooth</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_smooth</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
</span><span id="smooth-872"><a href="#smooth-872"><span class="linenos">872</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miss</span><span class="p">):</span>
</span><span id="smooth-873"><a href="#smooth-873"><span class="linenos">873</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column(s) not found in node table: </span><span class="si">{</span><span class="n">miss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="smooth-874"><a href="#smooth-874"><span class="linenos">874</span></a>
</span><span id="smooth-875"><a href="#smooth-875"><span class="linenos">875</span></a>    <span class="c1"># Go over each segment and smooth</span>
</span><span id="smooth-876"><a href="#smooth-876"><span class="linenos">876</span></a>    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">get_segments</span><span class="p">():</span>
</span><span id="smooth-877"><a href="#smooth-877"><span class="linenos">877</span></a>        <span class="c1"># Get this segment&#39;s parent distances and get cumsum</span>
</span><span id="smooth-878"><a href="#smooth-878"><span class="linenos">878</span></a>        <span class="n">this_co</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">,</span> <span class="n">to_smooth</span><span class="p">]</span>
</span><span id="smooth-879"><a href="#smooth-879"><span class="linenos">879</span></a>
</span><span id="smooth-880"><a href="#smooth-880"><span class="linenos">880</span></a>        <span class="n">interp</span> <span class="o">=</span> <span class="n">this_co</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="smooth-881"><a href="#smooth-881"><span class="linenos">881</span></a>
</span><span id="smooth-882"><a href="#smooth-882"><span class="linenos">882</span></a>        <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">,</span> <span class="n">to_smooth</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">values</span>
</span><span id="smooth-883"><a href="#smooth-883"><span class="linenos">883</span></a>
</span><span id="smooth-884"><a href="#smooth-884"><span class="linenos">884</span></a>    <span class="c1"># Reassign nodes</span>
</span><span id="smooth-885"><a href="#smooth-885"><span class="linenos">885</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="smooth-886"><a href="#smooth-886"><span class="linenos">886</span></a>
</span><span id="smooth-887"><a href="#smooth-887"><span class="linenos">887</span></a>    <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Smooth skeleton using rolling windows.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton to be processed.</li>
<li><strong>window</strong> (int, optional):
Size (N observations) of the rolling window in number of
nodes.</li>
<li><strong>to_smooth</strong> (list):
Columns of the node table to smooth. Should work with any
numeric column (e.g. 'radius').</li>
<li><strong>inplace</strong> (bool):
If False will make and return a copy of the skeleton. If
True, will modify the <code>s</code> inplace.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton with smoothed node table.</li>
</ul>
</div>


                </section>
                <section id="despike">
                            <input id="despike-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">despike</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sigma</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">max_spike_length</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="despike-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#despike"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="despike-890"><a href="#despike-890"><span class="linenos">890</span></a><span class="k">def</span><span class="w"> </span><span class="nf">despike</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_spike_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="despike-891"><a href="#despike-891"><span class="linenos">891</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove spikes in skeleton.</span>
</span><span id="despike-892"><a href="#despike-892"><span class="linenos">892</span></a>
</span><span id="despike-893"><a href="#despike-893"><span class="linenos">893</span></a><span class="sd">    For each node A, the euclidean distance to its next successor (parent)</span>
</span><span id="despike-894"><a href="#despike-894"><span class="linenos">894</span></a><span class="sd">    B and that node&#39;s successor C (i.e A-&gt;B-&gt;C) is computed. If</span>
</span><span id="despike-895"><a href="#despike-895"><span class="linenos">895</span></a><span class="sd">    :math:`\\frac{dist(A,B)}{dist(A,C)}&gt;sigma`, node B is considered a spike</span>
</span><span id="despike-896"><a href="#despike-896"><span class="linenos">896</span></a><span class="sd">    and realigned between A and C.</span>
</span><span id="despike-897"><a href="#despike-897"><span class="linenos">897</span></a>
</span><span id="despike-898"><a href="#despike-898"><span class="linenos">898</span></a><span class="sd">    Parameters</span>
</span><span id="despike-899"><a href="#despike-899"><span class="linenos">899</span></a><span class="sd">    ----------</span>
</span><span id="despike-900"><a href="#despike-900"><span class="linenos">900</span></a><span class="sd">    x :                 skeletor.Skeleton</span>
</span><span id="despike-901"><a href="#despike-901"><span class="linenos">901</span></a><span class="sd">                        Skeleton to be processed.</span>
</span><span id="despike-902"><a href="#despike-902"><span class="linenos">902</span></a><span class="sd">    sigma :             float | int, optional</span>
</span><span id="despike-903"><a href="#despike-903"><span class="linenos">903</span></a><span class="sd">                        Threshold for spike detection. Smaller sigma = more</span>
</span><span id="despike-904"><a href="#despike-904"><span class="linenos">904</span></a><span class="sd">                        aggressive spike detection.</span>
</span><span id="despike-905"><a href="#despike-905"><span class="linenos">905</span></a><span class="sd">    max_spike_length :  int, optional</span>
</span><span id="despike-906"><a href="#despike-906"><span class="linenos">906</span></a><span class="sd">                        Determines how long (# of nodes) a spike can be.</span>
</span><span id="despike-907"><a href="#despike-907"><span class="linenos">907</span></a><span class="sd">    inplace :           bool, optional</span>
</span><span id="despike-908"><a href="#despike-908"><span class="linenos">908</span></a><span class="sd">                        If False, a copy of the neuron is returned.</span>
</span><span id="despike-909"><a href="#despike-909"><span class="linenos">909</span></a><span class="sd">    reverse :           bool, optional</span>
</span><span id="despike-910"><a href="#despike-910"><span class="linenos">910</span></a><span class="sd">                        If True, will **also** walk the segments from proximal</span>
</span><span id="despike-911"><a href="#despike-911"><span class="linenos">911</span></a><span class="sd">                        to distal. Use this to catch spikes on e.g. terminal</span>
</span><span id="despike-912"><a href="#despike-912"><span class="linenos">912</span></a><span class="sd">                        nodes.</span>
</span><span id="despike-913"><a href="#despike-913"><span class="linenos">913</span></a>
</span><span id="despike-914"><a href="#despike-914"><span class="linenos">914</span></a><span class="sd">    Returns</span>
</span><span id="despike-915"><a href="#despike-915"><span class="linenos">915</span></a><span class="sd">    -------</span>
</span><span id="despike-916"><a href="#despike-916"><span class="linenos">916</span></a><span class="sd">    s                   skeletor.Skeleton</span>
</span><span id="despike-917"><a href="#despike-917"><span class="linenos">917</span></a><span class="sd">                        Despiked neuron.</span>
</span><span id="despike-918"><a href="#despike-918"><span class="linenos">918</span></a>
</span><span id="despike-919"><a href="#despike-919"><span class="linenos">919</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="despike-920"><a href="#despike-920"><span class="linenos">920</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="despike-921"><a href="#despike-921"><span class="linenos">921</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="despike-922"><a href="#despike-922"><span class="linenos">922</span></a>
</span><span id="despike-923"><a href="#despike-923"><span class="linenos">923</span></a>    <span class="c1"># Index nodes table by node ID</span>
</span><span id="despike-924"><a href="#despike-924"><span class="linenos">924</span></a>    <span class="n">this_nodes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="despike-925"><a href="#despike-925"><span class="linenos">925</span></a>
</span><span id="despike-926"><a href="#despike-926"><span class="linenos">926</span></a>    <span class="n">segments</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_segments</span><span class="p">()</span>
</span><span id="despike-927"><a href="#despike-927"><span class="linenos">927</span></a>    <span class="n">segs_to_walk</span> <span class="o">=</span> <span class="n">segments</span>
</span><span id="despike-928"><a href="#despike-928"><span class="linenos">928</span></a>
</span><span id="despike-929"><a href="#despike-929"><span class="linenos">929</span></a>    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
</span><span id="despike-930"><a href="#despike-930"><span class="linenos">930</span></a>        <span class="n">segs_to_walk</span> <span class="o">+=</span> <span class="n">segs_to_walk</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="despike-931"><a href="#despike-931"><span class="linenos">931</span></a>
</span><span id="despike-932"><a href="#despike-932"><span class="linenos">932</span></a>    <span class="c1"># For each spike length do -&gt; do this in reverse to correct the long</span>
</span><span id="despike-933"><a href="#despike-933"><span class="linenos">933</span></a>    <span class="c1"># spikes first</span>
</span><span id="despike-934"><a href="#despike-934"><span class="linenos">934</span></a>    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_spike_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="despike-935"><a href="#despike-935"><span class="linenos">935</span></a>        <span class="c1"># Go over all segments</span>
</span><span id="despike-936"><a href="#despike-936"><span class="linenos">936</span></a>        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segs_to_walk</span><span class="p">:</span>
</span><span id="despike-937"><a href="#despike-937"><span class="linenos">937</span></a>            <span class="c1"># Get nodes A, B and C of this segment</span>
</span><span id="despike-938"><a href="#despike-938"><span class="linenos">938</span></a>            <span class="n">this_A</span> <span class="o">=</span> <span class="n">this_nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">[:</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="despike-939"><a href="#despike-939"><span class="linenos">939</span></a>            <span class="n">this_B</span> <span class="o">=</span> <span class="n">this_nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="despike-940"><a href="#despike-940"><span class="linenos">940</span></a>            <span class="n">this_C</span> <span class="o">=</span> <span class="n">this_nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">[</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]]</span>
</span><span id="despike-941"><a href="#despike-941"><span class="linenos">941</span></a>
</span><span id="despike-942"><a href="#despike-942"><span class="linenos">942</span></a>            <span class="c1"># Get coordinates</span>
</span><span id="despike-943"><a href="#despike-943"><span class="linenos">943</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">this_A</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="despike-944"><a href="#despike-944"><span class="linenos">944</span></a>            <span class="n">B</span> <span class="o">=</span> <span class="n">this_B</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="despike-945"><a href="#despike-945"><span class="linenos">945</span></a>            <span class="n">C</span> <span class="o">=</span> <span class="n">this_C</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="despike-946"><a href="#despike-946"><span class="linenos">946</span></a>
</span><span id="despike-947"><a href="#despike-947"><span class="linenos">947</span></a>            <span class="c1"># Calculate euclidian distances A-&gt;B and A-&gt;C</span>
</span><span id="despike-948"><a href="#despike-948"><span class="linenos">948</span></a>            <span class="n">dist_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="despike-949"><a href="#despike-949"><span class="linenos">949</span></a>            <span class="n">dist_AC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">C</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="despike-950"><a href="#despike-950"><span class="linenos">950</span></a>
</span><span id="despike-951"><a href="#despike-951"><span class="linenos">951</span></a>            <span class="c1"># Get the spikes</span>
</span><span id="despike-952"><a href="#despike-952"><span class="linenos">952</span></a>            <span class="n">spikes_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="despike-953"><a href="#despike-953"><span class="linenos">953</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dist_AB</span><span class="p">,</span> <span class="n">dist_AC</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">dist_AC</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sigma</span>
</span><span id="despike-954"><a href="#despike-954"><span class="linenos">954</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="despike-955"><a href="#despike-955"><span class="linenos">955</span></a>            <span class="n">spikes</span> <span class="o">=</span> <span class="n">this_B</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">spikes_ix</span><span class="p">]</span>
</span><span id="despike-956"><a href="#despike-956"><span class="linenos">956</span></a>
</span><span id="despike-957"><a href="#despike-957"><span class="linenos">957</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">spikes</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="despike-958"><a href="#despike-958"><span class="linenos">958</span></a>                <span class="c1"># Interpolate new position(s) between A and C</span>
</span><span id="despike-959"><a href="#despike-959"><span class="linenos">959</span></a>                <span class="n">new_positions</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">spikes_ix</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">spikes_ix</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">spikes_ix</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="despike-960"><a href="#despike-960"><span class="linenos">960</span></a>
</span><span id="despike-961"><a href="#despike-961"><span class="linenos">961</span></a>                <span class="n">this_nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spikes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_positions</span>
</span><span id="despike-962"><a href="#despike-962"><span class="linenos">962</span></a>
</span><span id="despike-963"><a href="#despike-963"><span class="linenos">963</span></a>    <span class="c1"># Reassign node table</span>
</span><span id="despike-964"><a href="#despike-964"><span class="linenos">964</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">this_nodes</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="despike-965"><a href="#despike-965"><span class="linenos">965</span></a>
</span><span id="despike-966"><a href="#despike-966"><span class="linenos">966</span></a>    <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Remove spikes in skeleton.</p>

<p>For each node A, the euclidean distance to its next successor (parent)
B and that node's successor C (i.e A->B->C) is computed. If
\( \frac{dist(A,B)}{dist(A,C)}&gt;sigma \), node B is considered a spike
and realigned between A and C.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>x</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton to be processed.</li>
<li><strong>sigma</strong> (float | int, optional):
Threshold for spike detection. Smaller sigma = more
aggressive spike detection.</li>
<li><strong>max_spike_length</strong> (int, optional):
Determines how long (# of nodes) a spike can be.</li>
<li><strong>inplace</strong> (bool, optional):
If False, a copy of the neuron is returned.</li>
<li><strong>reverse</strong> (bool, optional):
If True, will <strong>also</strong> walk the segments from proximal
to distal. Use this to catch spikes on e.g. terminal
nodes.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s                   <a href="../skeletor.html#Skeleton">skeletor.Skeleton</a></strong>: Despiked neuron.</li>
</ul>
</div>


                </section>
                <section id="remove_bristles">
                            <input id="remove_bristles-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">remove_bristles</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">mesh</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">los_only</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="remove_bristles-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#remove_bristles"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="remove_bristles-93"><a href="#remove_bristles-93"><span class="linenos"> 93</span></a><span class="k">def</span><span class="w"> </span><span class="nf">remove_bristles</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">los_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="remove_bristles-94"><a href="#remove_bristles-94"><span class="linenos"> 94</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove &quot;bristles&quot; that sometimes occurr along the backbone.</span>
</span><span id="remove_bristles-95"><a href="#remove_bristles-95"><span class="linenos"> 95</span></a>
</span><span id="remove_bristles-96"><a href="#remove_bristles-96"><span class="linenos"> 96</span></a><span class="sd">    Works by finding terminal twigs that consist of only a single node.</span>
</span><span id="remove_bristles-97"><a href="#remove_bristles-97"><span class="linenos"> 97</span></a>
</span><span id="remove_bristles-98"><a href="#remove_bristles-98"><span class="linenos"> 98</span></a><span class="sd">    Parameters</span>
</span><span id="remove_bristles-99"><a href="#remove_bristles-99"><span class="linenos"> 99</span></a><span class="sd">    ----------</span>
</span><span id="remove_bristles-100"><a href="#remove_bristles-100"><span class="linenos">100</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="remove_bristles-101"><a href="#remove_bristles-101"><span class="linenos">101</span></a><span class="sd">                Skeleton to clean up.</span>
</span><span id="remove_bristles-102"><a href="#remove_bristles-102"><span class="linenos">102</span></a><span class="sd">    mesh :      trimesh.Trimesh, optional</span>
</span><span id="remove_bristles-103"><a href="#remove_bristles-103"><span class="linenos">103</span></a><span class="sd">                Original mesh (e.g. before contraction). If not provided will</span>
</span><span id="remove_bristles-104"><a href="#remove_bristles-104"><span class="linenos">104</span></a><span class="sd">                use the mesh associated with ``s``.</span>
</span><span id="remove_bristles-105"><a href="#remove_bristles-105"><span class="linenos">105</span></a><span class="sd">    los_only :  bool</span>
</span><span id="remove_bristles-106"><a href="#remove_bristles-106"><span class="linenos">106</span></a><span class="sd">                If True, will only remove bristles that are in line of sight of</span>
</span><span id="remove_bristles-107"><a href="#remove_bristles-107"><span class="linenos">107</span></a><span class="sd">                their parent. If False, will remove all single-node bristles.</span>
</span><span id="remove_bristles-108"><a href="#remove_bristles-108"><span class="linenos">108</span></a><span class="sd">    inplace :   bool</span>
</span><span id="remove_bristles-109"><a href="#remove_bristles-109"><span class="linenos">109</span></a><span class="sd">                If False will make and return a copy of the skeleton. If True,</span>
</span><span id="remove_bristles-110"><a href="#remove_bristles-110"><span class="linenos">110</span></a><span class="sd">                will modify the `s` inplace.</span>
</span><span id="remove_bristles-111"><a href="#remove_bristles-111"><span class="linenos">111</span></a>
</span><span id="remove_bristles-112"><a href="#remove_bristles-112"><span class="linenos">112</span></a><span class="sd">    Returns</span>
</span><span id="remove_bristles-113"><a href="#remove_bristles-113"><span class="linenos">113</span></a><span class="sd">    -------</span>
</span><span id="remove_bristles-114"><a href="#remove_bristles-114"><span class="linenos">114</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="remove_bristles-115"><a href="#remove_bristles-115"><span class="linenos">115</span></a><span class="sd">                Skeleton with single-node twigs removed.</span>
</span><span id="remove_bristles-116"><a href="#remove_bristles-116"><span class="linenos">116</span></a>
</span><span id="remove_bristles-117"><a href="#remove_bristles-117"><span class="linenos">117</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="remove_bristles-118"><a href="#remove_bristles-118"><span class="linenos">118</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="remove_bristles-119"><a href="#remove_bristles-119"><span class="linenos">119</span></a>        <span class="n">mesh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="remove_bristles-120"><a href="#remove_bristles-120"><span class="linenos">120</span></a>
</span><span id="remove_bristles-121"><a href="#remove_bristles-121"><span class="linenos">121</span></a>    <span class="c1"># Make a copy of the skeleton</span>
</span><span id="remove_bristles-122"><a href="#remove_bristles-122"><span class="linenos">122</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="remove_bristles-123"><a href="#remove_bristles-123"><span class="linenos">123</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="remove_bristles-124"><a href="#remove_bristles-124"><span class="linenos">124</span></a>
</span><span id="remove_bristles-125"><a href="#remove_bristles-125"><span class="linenos">125</span></a>    <span class="c1"># Find branch points</span>
</span><span id="remove_bristles-126"><a href="#remove_bristles-126"><span class="linenos">126</span></a>    <span class="n">pcount</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span id="remove_bristles-127"><a href="#remove_bristles-127"><span class="linenos">127</span></a>    <span class="n">bp</span> <span class="o">=</span> <span class="n">pcount</span><span class="p">[</span><span class="n">pcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
</span><span id="remove_bristles-128"><a href="#remove_bristles-128"><span class="linenos">128</span></a>
</span><span id="remove_bristles-129"><a href="#remove_bristles-129"><span class="linenos">129</span></a>    <span class="c1"># Find terminal twigs</span>
</span><span id="remove_bristles-130"><a href="#remove_bristles-130"><span class="linenos">130</span></a>    <span class="n">twigs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[</span><span class="o">~</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)]</span>
</span><span id="remove_bristles-131"><a href="#remove_bristles-131"><span class="linenos">131</span></a>    <span class="n">twigs</span> <span class="o">=</span> <span class="n">twigs</span><span class="p">[</span><span class="n">twigs</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bp</span><span class="p">)]</span>
</span><span id="remove_bristles-132"><a href="#remove_bristles-132"><span class="linenos">132</span></a>
</span><span id="remove_bristles-133"><a href="#remove_bristles-133"><span class="linenos">133</span></a>    <span class="k">if</span> <span class="n">twigs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="remove_bristles-134"><a href="#remove_bristles-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="remove_bristles-135"><a href="#remove_bristles-135"><span class="linenos">135</span></a>
</span><span id="remove_bristles-136"><a href="#remove_bristles-136"><span class="linenos">136</span></a>    <span class="k">if</span> <span class="n">los_only</span><span class="p">:</span>
</span><span id="remove_bristles-137"><a href="#remove_bristles-137"><span class="linenos">137</span></a>        <span class="c1"># Initialize ncollpyde Volume</span>
</span><span id="remove_bristles-138"><a href="#remove_bristles-138"><span class="linenos">138</span></a>        <span class="n">coll</span> <span class="o">=</span> <span class="n">ncollpyde</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="remove_bristles-139"><a href="#remove_bristles-139"><span class="linenos">139</span></a>
</span><span id="remove_bristles-140"><a href="#remove_bristles-140"><span class="linenos">140</span></a>        <span class="c1"># Remove twigs that aren&#39;t inside the volume</span>
</span><span id="remove_bristles-141"><a href="#remove_bristles-141"><span class="linenos">141</span></a>        <span class="n">twigs</span> <span class="o">=</span> <span class="n">twigs</span><span class="p">[</span><span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">twigs</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
</span><span id="remove_bristles-142"><a href="#remove_bristles-142"><span class="linenos">142</span></a>
</span><span id="remove_bristles-143"><a href="#remove_bristles-143"><span class="linenos">143</span></a>        <span class="c1"># Generate rays between all pairs and their parents</span>
</span><span id="remove_bristles-144"><a href="#remove_bristles-144"><span class="linenos">144</span></a>        <span class="n">sources</span> <span class="o">=</span> <span class="n">twigs</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="remove_bristles-145"><a href="#remove_bristles-145"><span class="linenos">145</span></a>        <span class="n">targets</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="remove_bristles-146"><a href="#remove_bristles-146"><span class="linenos">146</span></a>            <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">twigs</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="remove_bristles-147"><a href="#remove_bristles-147"><span class="linenos">147</span></a>        <span class="p">)</span>
</span><span id="remove_bristles-148"><a href="#remove_bristles-148"><span class="linenos">148</span></a>
</span><span id="remove_bristles-149"><a href="#remove_bristles-149"><span class="linenos">149</span></a>        <span class="c1"># Get intersections: `ix` points to index of line segment; `loc` is the</span>
</span><span id="remove_bristles-150"><a href="#remove_bristles-150"><span class="linenos">150</span></a>        <span class="c1">#  x/y/z coordinate of the intersection and `is_backface` is True if</span>
</span><span id="remove_bristles-151"><a href="#remove_bristles-151"><span class="linenos">151</span></a>        <span class="c1"># intersection happened at the inside of a mesh</span>
</span><span id="remove_bristles-152"><a href="#remove_bristles-152"><span class="linenos">152</span></a>        <span class="n">ix</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">is_backface</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">intersections</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</span><span id="remove_bristles-153"><a href="#remove_bristles-153"><span class="linenos">153</span></a>
</span><span id="remove_bristles-154"><a href="#remove_bristles-154"><span class="linenos">154</span></a>        <span class="c1"># Find pairs of twigs with no intersection - i.e. with line of sight</span>
</span><span id="remove_bristles-155"><a href="#remove_bristles-155"><span class="linenos">155</span></a>        <span class="n">los</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ix</span><span class="p">)</span>
</span><span id="remove_bristles-156"><a href="#remove_bristles-156"><span class="linenos">156</span></a>
</span><span id="remove_bristles-157"><a href="#remove_bristles-157"><span class="linenos">157</span></a>        <span class="c1"># To remove: have line of sight</span>
</span><span id="remove_bristles-158"><a href="#remove_bristles-158"><span class="linenos">158</span></a>        <span class="n">to_remove</span> <span class="o">=</span> <span class="n">twigs</span><span class="p">[</span><span class="n">los</span><span class="p">]</span>
</span><span id="remove_bristles-159"><a href="#remove_bristles-159"><span class="linenos">159</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="remove_bristles-160"><a href="#remove_bristles-160"><span class="linenos">160</span></a>        <span class="n">to_remove</span> <span class="o">=</span> <span class="n">twigs</span>
</span><span id="remove_bristles-161"><a href="#remove_bristles-161"><span class="linenos">161</span></a>
</span><span id="remove_bristles-162"><a href="#remove_bristles-162"><span class="linenos">162</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[</span><span class="o">~</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_remove</span><span class="o">.</span><span class="n">node_id</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="remove_bristles-163"><a href="#remove_bristles-163"><span class="linenos">163</span></a>
</span><span id="remove_bristles-164"><a href="#remove_bristles-164"><span class="linenos">164</span></a>    <span class="c1"># Update the mesh map</span>
</span><span id="remove_bristles-165"><a href="#remove_bristles-165"><span class="linenos">165</span></a>    <span class="n">mesh_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;mesh_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="remove_bristles-166"><a href="#remove_bristles-166"><span class="linenos">166</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh_map</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="remove_bristles-167"><a href="#remove_bristles-167"><span class="linenos">167</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
</span><span id="remove_bristles-168"><a href="#remove_bristles-168"><span class="linenos">168</span></a>            <span class="n">mesh_map</span><span class="p">[</span><span class="n">mesh_map</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">parent_id</span>
</span><span id="remove_bristles-169"><a href="#remove_bristles-169"><span class="linenos">169</span></a>
</span><span id="remove_bristles-170"><a href="#remove_bristles-170"><span class="linenos">170</span></a>    <span class="c1"># Reindex nodes</span>
</span><span id="remove_bristles-171"><a href="#remove_bristles-171"><span class="linenos">171</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="remove_bristles-172"><a href="#remove_bristles-172"><span class="linenos">172</span></a>
</span><span id="remove_bristles-173"><a href="#remove_bristles-173"><span class="linenos">173</span></a>    <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Remove "bristles" that sometimes occurr along the backbone.</p>

<p>Works by finding terminal twigs that consist of only a single node.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton to clean up.</li>
<li><strong>mesh</strong> (trimesh.Trimesh, optional):
Original mesh (e.g. before contraction). If not provided will
use the mesh associated with <code>s</code>.</li>
<li><strong>los_only</strong> (bool):
If True, will only remove bristles that are in line of sight of
their parent. If False, will remove all single-node bristles.</li>
<li><strong>inplace</strong> (bool):
If False will make and return a copy of the skeleton. If True,
will modify the <code>s</code> inplace.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton with single-node twigs removed.</li>
</ul>
</div>


                </section>
                <section id="recenter_vertices">
                            <input id="recenter_vertices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">recenter_vertices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">mesh</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="recenter_vertices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#recenter_vertices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="recenter_vertices-176"><a href="#recenter_vertices-176"><span class="linenos">176</span></a><span class="k">def</span><span class="w"> </span><span class="nf">recenter_vertices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="recenter_vertices-177"><a href="#recenter_vertices-177"><span class="linenos">177</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Move nodes that ended up outside the mesh back inside.</span>
</span><span id="recenter_vertices-178"><a href="#recenter_vertices-178"><span class="linenos">178</span></a>
</span><span id="recenter_vertices-179"><a href="#recenter_vertices-179"><span class="linenos">179</span></a><span class="sd">    Nodes can end up outside the original mesh e.g. if the mesh contraction</span>
</span><span id="recenter_vertices-180"><a href="#recenter_vertices-180"><span class="linenos">180</span></a><span class="sd">    didn&#39;t do a good job (most likely because of internal/degenerate faces that</span>
</span><span id="recenter_vertices-181"><a href="#recenter_vertices-181"><span class="linenos">181</span></a><span class="sd">    messed up the normals). This function rectifies this by snapping those nodes</span>
</span><span id="recenter_vertices-182"><a href="#recenter_vertices-182"><span class="linenos">182</span></a><span class="sd">    nodes back to the closest vertex and then tries to move them into the</span>
</span><span id="recenter_vertices-183"><a href="#recenter_vertices-183"><span class="linenos">183</span></a><span class="sd">    mesh&#39;s center. That second step is not guaranteed to work but at least you</span>
</span><span id="recenter_vertices-184"><a href="#recenter_vertices-184"><span class="linenos">184</span></a><span class="sd">    won&#39;t have any more nodes outside the mesh.</span>
</span><span id="recenter_vertices-185"><a href="#recenter_vertices-185"><span class="linenos">185</span></a>
</span><span id="recenter_vertices-186"><a href="#recenter_vertices-186"><span class="linenos">186</span></a><span class="sd">    Please note that if connected (!) nodes end up on the same position (i.e</span>
</span><span id="recenter_vertices-187"><a href="#recenter_vertices-187"><span class="linenos">187</span></a><span class="sd">    because they snapped to the same vertex), we will collapse them.</span>
</span><span id="recenter_vertices-188"><a href="#recenter_vertices-188"><span class="linenos">188</span></a>
</span><span id="recenter_vertices-189"><a href="#recenter_vertices-189"><span class="linenos">189</span></a><span class="sd">    Parameters</span>
</span><span id="recenter_vertices-190"><a href="#recenter_vertices-190"><span class="linenos">190</span></a><span class="sd">    ----------</span>
</span><span id="recenter_vertices-191"><a href="#recenter_vertices-191"><span class="linenos">191</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="recenter_vertices-192"><a href="#recenter_vertices-192"><span class="linenos">192</span></a><span class="sd">    mesh :      trimesh.Trimesh</span>
</span><span id="recenter_vertices-193"><a href="#recenter_vertices-193"><span class="linenos">193</span></a><span class="sd">                Original mesh.</span>
</span><span id="recenter_vertices-194"><a href="#recenter_vertices-194"><span class="linenos">194</span></a><span class="sd">    inplace :   bool</span>
</span><span id="recenter_vertices-195"><a href="#recenter_vertices-195"><span class="linenos">195</span></a><span class="sd">                If False will make and return a copy of the skeleton. If True,</span>
</span><span id="recenter_vertices-196"><a href="#recenter_vertices-196"><span class="linenos">196</span></a><span class="sd">                will modify the `s` inplace.</span>
</span><span id="recenter_vertices-197"><a href="#recenter_vertices-197"><span class="linenos">197</span></a>
</span><span id="recenter_vertices-198"><a href="#recenter_vertices-198"><span class="linenos">198</span></a><span class="sd">    Returns</span>
</span><span id="recenter_vertices-199"><a href="#recenter_vertices-199"><span class="linenos">199</span></a><span class="sd">    -------</span>
</span><span id="recenter_vertices-200"><a href="#recenter_vertices-200"><span class="linenos">200</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="recenter_vertices-201"><a href="#recenter_vertices-201"><span class="linenos">201</span></a><span class="sd">                Skeleton with vertices recentered.</span>
</span><span id="recenter_vertices-202"><a href="#recenter_vertices-202"><span class="linenos">202</span></a>
</span><span id="recenter_vertices-203"><a href="#recenter_vertices-203"><span class="linenos">203</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="recenter_vertices-204"><a href="#recenter_vertices-204"><span class="linenos">204</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="recenter_vertices-205"><a href="#recenter_vertices-205"><span class="linenos">205</span></a>        <span class="n">mesh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="recenter_vertices-206"><a href="#recenter_vertices-206"><span class="linenos">206</span></a>
</span><span id="recenter_vertices-207"><a href="#recenter_vertices-207"><span class="linenos">207</span></a>    <span class="c1"># Copy skeleton</span>
</span><span id="recenter_vertices-208"><a href="#recenter_vertices-208"><span class="linenos">208</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="recenter_vertices-209"><a href="#recenter_vertices-209"><span class="linenos">209</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="recenter_vertices-210"><a href="#recenter_vertices-210"><span class="linenos">210</span></a>
</span><span id="recenter_vertices-211"><a href="#recenter_vertices-211"><span class="linenos">211</span></a>    <span class="c1"># Find nodes that are outside the mesh</span>
</span><span id="recenter_vertices-212"><a href="#recenter_vertices-212"><span class="linenos">212</span></a>    <span class="n">coll</span> <span class="o">=</span> <span class="n">ncollpyde</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="recenter_vertices-213"><a href="#recenter_vertices-213"><span class="linenos">213</span></a>    <span class="n">outside</span> <span class="o">=</span> <span class="o">~</span><span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
</span><span id="recenter_vertices-214"><a href="#recenter_vertices-214"><span class="linenos">214</span></a>
</span><span id="recenter_vertices-215"><a href="#recenter_vertices-215"><span class="linenos">215</span></a>    <span class="c1"># Skip if all inside</span>
</span><span id="recenter_vertices-216"><a href="#recenter_vertices-216"><span class="linenos">216</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">outside</span><span class="p">):</span>
</span><span id="recenter_vertices-217"><a href="#recenter_vertices-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="recenter_vertices-218"><a href="#recenter_vertices-218"><span class="linenos">218</span></a>
</span><span id="recenter_vertices-219"><a href="#recenter_vertices-219"><span class="linenos">219</span></a>    <span class="c1"># For each outside find the closest vertex</span>
</span><span id="recenter_vertices-220"><a href="#recenter_vertices-220"><span class="linenos">220</span></a>    <span class="n">tree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
</span><span id="recenter_vertices-221"><a href="#recenter_vertices-221"><span class="linenos">221</span></a>
</span><span id="recenter_vertices-222"><a href="#recenter_vertices-222"><span class="linenos">222</span></a>    <span class="c1"># Find nodes that are right on top of original vertices</span>
</span><span id="recenter_vertices-223"><a href="#recenter_vertices-223"><span class="linenos">223</span></a>    <span class="n">dist</span><span class="p">,</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">outside</span><span class="p">])</span>
</span><span id="recenter_vertices-224"><a href="#recenter_vertices-224"><span class="linenos">224</span></a>
</span><span id="recenter_vertices-225"><a href="#recenter_vertices-225"><span class="linenos">225</span></a>    <span class="c1"># We don&#39;t want to just snap them back to the closest vertex but try to find</span>
</span><span id="recenter_vertices-226"><a href="#recenter_vertices-226"><span class="linenos">226</span></a>    <span class="c1"># the center. For this we will:</span>
</span><span id="recenter_vertices-227"><a href="#recenter_vertices-227"><span class="linenos">227</span></a>    <span class="c1"># 1. Move each vertex inside the mesh by just a bit</span>
</span><span id="recenter_vertices-228"><a href="#recenter_vertices-228"><span class="linenos">228</span></a>    <span class="c1"># 2. Cast a ray along the vertices&#39; normals and find the opposite sides of the mesh</span>
</span><span id="recenter_vertices-229"><a href="#recenter_vertices-229"><span class="linenos">229</span></a>    <span class="c1"># 3. Calculate the distance</span>
</span><span id="recenter_vertices-230"><a href="#recenter_vertices-230"><span class="linenos">230</span></a>
</span><span id="recenter_vertices-231"><a href="#recenter_vertices-231"><span class="linenos">231</span></a>    <span class="c1"># Get the closest vertex...</span>
</span><span id="recenter_vertices-232"><a href="#recenter_vertices-232"><span class="linenos">232</span></a>    <span class="n">closest_vertex</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
</span><span id="recenter_vertices-233"><a href="#recenter_vertices-233"><span class="linenos">233</span></a>    <span class="c1"># .. and offset the vertex positions by just a bit so they &quot;should&quot; be</span>
</span><span id="recenter_vertices-234"><a href="#recenter_vertices-234"><span class="linenos">234</span></a>    <span class="c1"># inside the mesh. In reality that doesn&#39;t always happen if the mesh is not</span>
</span><span id="recenter_vertices-235"><a href="#recenter_vertices-235"><span class="linenos">235</span></a>    <span class="c1"># watertight</span>
</span><span id="recenter_vertices-236"><a href="#recenter_vertices-236"><span class="linenos">236</span></a>    <span class="n">vnormals</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex_normals</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
</span><span id="recenter_vertices-237"><a href="#recenter_vertices-237"><span class="linenos">237</span></a>    <span class="n">sources</span> <span class="o">=</span> <span class="n">closest_vertex</span> <span class="o">-</span> <span class="n">vnormals</span>
</span><span id="recenter_vertices-238"><a href="#recenter_vertices-238"><span class="linenos">238</span></a>
</span><span id="recenter_vertices-239"><a href="#recenter_vertices-239"><span class="linenos">239</span></a>    <span class="c1"># Prepare rays to cast</span>
</span><span id="recenter_vertices-240"><a href="#recenter_vertices-240"><span class="linenos">240</span></a>    <span class="n">targets</span> <span class="o">=</span> <span class="n">sources</span> <span class="o">-</span> <span class="n">vnormals</span> <span class="o">*</span> <span class="mf">1e4</span>
</span><span id="recenter_vertices-241"><a href="#recenter_vertices-241"><span class="linenos">241</span></a>
</span><span id="recenter_vertices-242"><a href="#recenter_vertices-242"><span class="linenos">242</span></a>    <span class="c1"># Cast rays</span>
</span><span id="recenter_vertices-243"><a href="#recenter_vertices-243"><span class="linenos">243</span></a>    <span class="n">hit_ix</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">is_backface</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">intersections</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</span><span id="recenter_vertices-244"><a href="#recenter_vertices-244"><span class="linenos">244</span></a>
</span><span id="recenter_vertices-245"><a href="#recenter_vertices-245"><span class="linenos">245</span></a>    <span class="c1"># center-point if ray hits, otherwise keep closest_vertex</span>
</span><span id="recenter_vertices-246"><a href="#recenter_vertices-246"><span class="linenos">246</span></a>    <span class="n">final_pos</span> <span class="o">=</span> <span class="n">closest_vertex</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="recenter_vertices-247"><a href="#recenter_vertices-247"><span class="linenos">247</span></a>
</span><span id="recenter_vertices-248"><a href="#recenter_vertices-248"><span class="linenos">248</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="recenter_vertices-249"><a href="#recenter_vertices-249"><span class="linenos">249</span></a>        <span class="c1"># Get half-vector</span>
</span><span id="recenter_vertices-250"><a href="#recenter_vertices-250"><span class="linenos">250</span></a>        <span class="n">halfvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="recenter_vertices-251"><a href="#recenter_vertices-251"><span class="linenos">251</span></a>        <span class="n">halfvec</span><span class="p">[</span><span class="n">hit_ix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loc</span> <span class="o">-</span> <span class="n">closest_vertex</span><span class="p">[</span><span class="n">hit_ix</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="recenter_vertices-252"><a href="#recenter_vertices-252"><span class="linenos">252</span></a>
</span><span id="recenter_vertices-253"><a href="#recenter_vertices-253"><span class="linenos">253</span></a>        <span class="c1"># Offset vertices</span>
</span><span id="recenter_vertices-254"><a href="#recenter_vertices-254"><span class="linenos">254</span></a>        <span class="n">candidate</span> <span class="o">=</span> <span class="n">closest_vertex</span> <span class="o">+</span> <span class="n">halfvec</span>
</span><span id="recenter_vertices-255"><a href="#recenter_vertices-255"><span class="linenos">255</span></a>
</span><span id="recenter_vertices-256"><a href="#recenter_vertices-256"><span class="linenos">256</span></a>        <span class="c1"># Keep only those that are properly inside the mesh</span>
</span><span id="recenter_vertices-257"><a href="#recenter_vertices-257"><span class="linenos">257</span></a>        <span class="n">now_inside</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
</span><span id="recenter_vertices-258"><a href="#recenter_vertices-258"><span class="linenos">258</span></a>        <span class="n">final_pos</span><span class="p">[</span><span class="n">now_inside</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate</span><span class="p">[</span><span class="n">now_inside</span><span class="p">]</span>
</span><span id="recenter_vertices-259"><a href="#recenter_vertices-259"><span class="linenos">259</span></a>
</span><span id="recenter_vertices-260"><a href="#recenter_vertices-260"><span class="linenos">260</span></a>    <span class="c1"># try harder to get strictly inside</span>
</span><span id="recenter_vertices-261"><a href="#recenter_vertices-261"><span class="linenos">261</span></a>    <span class="n">still_outside</span> <span class="o">=</span> <span class="o">~</span><span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">final_pos</span><span class="p">)</span>
</span><span id="recenter_vertices-262"><a href="#recenter_vertices-262"><span class="linenos">262</span></a>    <span class="k">if</span> <span class="n">still_outside</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="recenter_vertices-263"><a href="#recenter_vertices-263"><span class="linenos">263</span></a>        <span class="n">push</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="recenter_vertices-264"><a href="#recenter_vertices-264"><span class="linenos">264</span></a>            <span class="n">mesh</span><span class="o">.</span><span class="n">edges_unique_length</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="recenter_vertices-265"><a href="#recenter_vertices-265"><span class="linenos">265</span></a>            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">edges_unique_length</span><span class="o">.</span><span class="n">size</span>
</span><span id="recenter_vertices-266"><a href="#recenter_vertices-266"><span class="linenos">266</span></a>            <span class="k">else</span> <span class="mf">1e-4</span>
</span><span id="recenter_vertices-267"><a href="#recenter_vertices-267"><span class="linenos">267</span></a>        <span class="p">)</span>  <span class="c1"># for high-res meshes</span>
</span><span id="recenter_vertices-268"><a href="#recenter_vertices-268"><span class="linenos">268</span></a>        <span class="n">push</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">push</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">)</span>
</span><span id="recenter_vertices-269"><a href="#recenter_vertices-269"><span class="linenos">269</span></a>
</span><span id="recenter_vertices-270"><a href="#recenter_vertices-270"><span class="linenos">270</span></a>        <span class="n">candidate_in</span> <span class="o">=</span> <span class="n">closest_vertex</span> <span class="o">-</span> <span class="n">vnormals</span> <span class="o">*</span> <span class="n">push</span>
</span><span id="recenter_vertices-271"><a href="#recenter_vertices-271"><span class="linenos">271</span></a>        <span class="n">candidate_out</span> <span class="o">=</span> <span class="n">closest_vertex</span> <span class="o">+</span> <span class="n">vnormals</span> <span class="o">*</span> <span class="n">push</span>
</span><span id="recenter_vertices-272"><a href="#recenter_vertices-272"><span class="linenos">272</span></a>
</span><span id="recenter_vertices-273"><a href="#recenter_vertices-273"><span class="linenos">273</span></a>        <span class="n">in_ok</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">candidate_in</span><span class="p">)</span>
</span><span id="recenter_vertices-274"><a href="#recenter_vertices-274"><span class="linenos">274</span></a>        <span class="n">out_ok</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">candidate_out</span><span class="p">)</span>
</span><span id="recenter_vertices-275"><a href="#recenter_vertices-275"><span class="linenos">275</span></a>
</span><span id="recenter_vertices-276"><a href="#recenter_vertices-276"><span class="linenos">276</span></a>        <span class="n">use_in</span> <span class="o">=</span> <span class="n">still_outside</span> <span class="o">&amp;</span> <span class="n">in_ok</span>
</span><span id="recenter_vertices-277"><a href="#recenter_vertices-277"><span class="linenos">277</span></a>        <span class="n">use_out</span> <span class="o">=</span> <span class="n">still_outside</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">in_ok</span> <span class="o">&amp;</span> <span class="n">out_ok</span>
</span><span id="recenter_vertices-278"><a href="#recenter_vertices-278"><span class="linenos">278</span></a>
</span><span id="recenter_vertices-279"><a href="#recenter_vertices-279"><span class="linenos">279</span></a>        <span class="n">final_pos</span><span class="p">[</span><span class="n">use_in</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_in</span><span class="p">[</span><span class="n">use_in</span><span class="p">]</span>
</span><span id="recenter_vertices-280"><a href="#recenter_vertices-280"><span class="linenos">280</span></a>        <span class="n">final_pos</span><span class="p">[</span><span class="n">use_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_out</span><span class="p">[</span><span class="n">use_out</span><span class="p">]</span>
</span><span id="recenter_vertices-281"><a href="#recenter_vertices-281"><span class="linenos">281</span></a>
</span><span id="recenter_vertices-282"><a href="#recenter_vertices-282"><span class="linenos">282</span></a>    <span class="c1"># Keep only those that are properly inside the mesh and fall back to the</span>
</span><span id="recenter_vertices-283"><a href="#recenter_vertices-283"><span class="linenos">283</span></a>    <span class="c1"># closest vertex if that&#39;s not the case</span>
</span><span id="recenter_vertices-284"><a href="#recenter_vertices-284"><span class="linenos">284</span></a>    <span class="n">now_inside</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">final_pos</span><span class="p">)</span>
</span><span id="recenter_vertices-285"><a href="#recenter_vertices-285"><span class="linenos">285</span></a>    <span class="n">final_pos</span><span class="p">[</span><span class="o">~</span><span class="n">now_inside</span><span class="p">]</span> <span class="o">=</span> <span class="n">closest_vertex</span><span class="p">[</span><span class="o">~</span><span class="n">now_inside</span><span class="p">]</span>
</span><span id="recenter_vertices-286"><a href="#recenter_vertices-286"><span class="linenos">286</span></a>
</span><span id="recenter_vertices-287"><a href="#recenter_vertices-287"><span class="linenos">287</span></a>    <span class="c1"># Replace coordinates</span>
</span><span id="recenter_vertices-288"><a href="#recenter_vertices-288"><span class="linenos">288</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outside</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="recenter_vertices-289"><a href="#recenter_vertices-289"><span class="linenos">289</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outside</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="recenter_vertices-290"><a href="#recenter_vertices-290"><span class="linenos">290</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outside</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="recenter_vertices-291"><a href="#recenter_vertices-291"><span class="linenos">291</span></a>
</span><span id="recenter_vertices-292"><a href="#recenter_vertices-292"><span class="linenos">292</span></a>    <span class="c1"># At this point we may have nodes that snapped to the same vertex and</span>
</span><span id="recenter_vertices-293"><a href="#recenter_vertices-293"><span class="linenos">293</span></a>    <span class="c1"># therefore end up at the same position. We will collapse those nodes</span>
</span><span id="recenter_vertices-294"><a href="#recenter_vertices-294"><span class="linenos">294</span></a>    <span class="c1"># - but only if they are actually connected!</span>
</span><span id="recenter_vertices-295"><a href="#recenter_vertices-295"><span class="linenos">295</span></a>    <span class="c1"># First find duplicate locations</span>
</span><span id="recenter_vertices-296"><a href="#recenter_vertices-296"><span class="linenos">296</span></a>    <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="recenter_vertices-297"><a href="#recenter_vertices-297"><span class="linenos">297</span></a>
</span><span id="recenter_vertices-298"><a href="#recenter_vertices-298"><span class="linenos">298</span></a>    <span class="c1"># If any coordinates have counter higher 1</span>
</span><span id="recenter_vertices-299"><a href="#recenter_vertices-299"><span class="linenos">299</span></a>    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="recenter_vertices-300"><a href="#recenter_vertices-300"><span class="linenos">300</span></a>        <span class="n">rewire</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="recenter_vertices-301"><a href="#recenter_vertices-301"><span class="linenos">301</span></a>        <span class="c1"># Find out which unique coordinates are duplicated</span>
</span><span id="recenter_vertices-302"><a href="#recenter_vertices-302"><span class="linenos">302</span></a>        <span class="n">dupl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="recenter_vertices-303"><a href="#recenter_vertices-303"><span class="linenos">303</span></a>
</span><span id="recenter_vertices-304"><a href="#recenter_vertices-304"><span class="linenos">304</span></a>        <span class="c1"># Go over each duplicated coordinate</span>
</span><span id="recenter_vertices-305"><a href="#recenter_vertices-305"><span class="linenos">305</span></a>        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">dupl</span><span class="p">:</span>
</span><span id="recenter_vertices-306"><a href="#recenter_vertices-306"><span class="linenos">306</span></a>            <span class="c1"># Find the nodes on this duplicate coordinate</span>
</span><span id="recenter_vertices-307"><a href="#recenter_vertices-307"><span class="linenos">307</span></a>            <span class="n">node_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="recenter_vertices-308"><a href="#recenter_vertices-308"><span class="linenos">308</span></a>
</span><span id="recenter_vertices-309"><a href="#recenter_vertices-309"><span class="linenos">309</span></a>            <span class="c1"># Get their edges</span>
</span><span id="recenter_vertices-310"><a href="#recenter_vertices-310"><span class="linenos">310</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="n">node_ix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="recenter_vertices-311"><a href="#recenter_vertices-311"><span class="linenos">311</span></a>
</span><span id="recenter_vertices-312"><a href="#recenter_vertices-312"><span class="linenos">312</span></a>            <span class="c1"># We will work on the graph to collapse nodes sequentially A-&gt;B-&gt;C</span>
</span><span id="recenter_vertices-313"><a href="#recenter_vertices-313"><span class="linenos">313</span></a>            <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
</span><span id="recenter_vertices-314"><a href="#recenter_vertices-314"><span class="linenos">314</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="recenter_vertices-315"><a href="#recenter_vertices-315"><span class="linenos">315</span></a>            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()):</span>
</span><span id="recenter_vertices-316"><a href="#recenter_vertices-316"><span class="linenos">316</span></a>                <span class="c1"># Root is the node without any outdegree in this subgraph</span>
</span><span id="recenter_vertices-317"><a href="#recenter_vertices-317"><span class="linenos">317</span></a>                <span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cc</span> <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">out_degree</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="recenter_vertices-318"><a href="#recenter_vertices-318"><span class="linenos">318</span></a>                <span class="c1"># We don&#39;t want to collapse into `root` because it&#39;s not actually</span>
</span><span id="recenter_vertices-319"><a href="#recenter_vertices-319"><span class="linenos">319</span></a>                <span class="c1"># among the nodes with the same coordinates but rather the &quot;last&quot;</span>
</span><span id="recenter_vertices-320"><a href="#recenter_vertices-320"><span class="linenos">320</span></a>                <span class="c1"># nodes parent</span>
</span><span id="recenter_vertices-321"><a href="#recenter_vertices-321"><span class="linenos">321</span></a>                <span class="n">clps_into</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
</span><span id="recenter_vertices-322"><a href="#recenter_vertices-322"><span class="linenos">322</span></a>                <span class="c1"># Keep track of how we need to rewire</span>
</span><span id="recenter_vertices-323"><a href="#recenter_vertices-323"><span class="linenos">323</span></a>                <span class="n">rewire</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">c</span><span class="p">:</span> <span class="n">clps_into</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cc</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">root</span><span class="p">,</span> <span class="n">clps_into</span><span class="p">}})</span>
</span><span id="recenter_vertices-324"><a href="#recenter_vertices-324"><span class="linenos">324</span></a>
</span><span id="recenter_vertices-325"><a href="#recenter_vertices-325"><span class="linenos">325</span></a>        <span class="c1"># Only mess with the skeleton if there were nodes to be merged</span>
</span><span id="recenter_vertices-326"><a href="#recenter_vertices-326"><span class="linenos">326</span></a>        <span class="k">if</span> <span class="n">rewire</span><span class="p">:</span>
</span><span id="recenter_vertices-327"><a href="#recenter_vertices-327"><span class="linenos">327</span></a>            <span class="c1"># Rewire</span>
</span><span id="recenter_vertices-328"><a href="#recenter_vertices-328"><span class="linenos">328</span></a>            <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rewire</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</span><span id="recenter_vertices-329"><a href="#recenter_vertices-329"><span class="linenos">329</span></a>
</span><span id="recenter_vertices-330"><a href="#recenter_vertices-330"><span class="linenos">330</span></a>            <span class="c1"># Drop nodes that were collapsed</span>
</span><span id="recenter_vertices-331"><a href="#recenter_vertices-331"><span class="linenos">331</span></a>            <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rewire</span><span class="p">)]</span>
</span><span id="recenter_vertices-332"><a href="#recenter_vertices-332"><span class="linenos">332</span></a>
</span><span id="recenter_vertices-333"><a href="#recenter_vertices-333"><span class="linenos">333</span></a>            <span class="c1"># Update mesh map</span>
</span><span id="recenter_vertices-334"><a href="#recenter_vertices-334"><span class="linenos">334</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">mesh_map</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="recenter_vertices-335"><a href="#recenter_vertices-335"><span class="linenos">335</span></a>                <span class="n">s</span><span class="o">.</span><span class="n">mesh_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">rewire</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh_map</span><span class="p">]</span>
</span><span id="recenter_vertices-336"><a href="#recenter_vertices-336"><span class="linenos">336</span></a>
</span><span id="recenter_vertices-337"><a href="#recenter_vertices-337"><span class="linenos">337</span></a>            <span class="c1"># Reindex to make vertex IDs continous again</span>
</span><span id="recenter_vertices-338"><a href="#recenter_vertices-338"><span class="linenos">338</span></a>            <span class="n">s</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="recenter_vertices-339"><a href="#recenter_vertices-339"><span class="linenos">339</span></a>
</span><span id="recenter_vertices-340"><a href="#recenter_vertices-340"><span class="linenos">340</span></a>            <span class="c1"># This prevents future SettingsWithCopy Warnings:</span>
</span><span id="recenter_vertices-341"><a href="#recenter_vertices-341"><span class="linenos">341</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="recenter_vertices-342"><a href="#recenter_vertices-342"><span class="linenos">342</span></a>                <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="recenter_vertices-343"><a href="#recenter_vertices-343"><span class="linenos">343</span></a>
</span><span id="recenter_vertices-344"><a href="#recenter_vertices-344"><span class="linenos">344</span></a>    <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Move nodes that ended up outside the mesh back inside.</p>

<p>Nodes can end up outside the original mesh e.g. if the mesh contraction
didn't do a good job (most likely because of internal/degenerate faces that
messed up the normals). This function rectifies this by snapping those nodes
nodes back to the closest vertex and then tries to move them into the
mesh's center. That second step is not guaranteed to work but at least you
won't have any more nodes outside the mesh.</p>

<p>Please note that if connected (!) nodes end up on the same position (i.e
because they snapped to the same vertex), we will collapse them.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><p><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):</p></li>
<li><p><strong>mesh</strong> (trimesh.Trimesh):
Original mesh.</p></li>
<li><strong>inplace</strong> (bool):
If False will make and return a copy of the skeleton. If True,
will modify the <code>s</code> inplace.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):
Skeleton with vertices recentered.</li>
</ul>
</div>


                </section>
                <section id="fix_outside_edges">
                            <input id="fix_outside_edges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fix_outside_edges</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">mesh</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">max_iter</span><span class="o">=</span><span class="mi">8</span>, </span><span class="param"><span class="n">smooth_iters</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">eps</span><span class="o">=</span><span class="mf">1e-06</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fix_outside_edges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fix_outside_edges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fix_outside_edges-347"><a href="#fix_outside_edges-347"><span class="linenos">347</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fix_outside_edges</span><span class="p">(</span>
</span><span id="fix_outside_edges-348"><a href="#fix_outside_edges-348"><span class="linenos">348</span></a>    <span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">smooth_iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span>
</span><span id="fix_outside_edges-349"><a href="#fix_outside_edges-349"><span class="linenos">349</span></a><span class="p">):</span>
</span><span id="fix_outside_edges-350"><a href="#fix_outside_edges-350"><span class="linenos">350</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix edges that cross outside the mesh boundary.</span>
</span><span id="fix_outside_edges-351"><a href="#fix_outside_edges-351"><span class="linenos">351</span></a>
</span><span id="fix_outside_edges-352"><a href="#fix_outside_edges-352"><span class="linenos">352</span></a><span class="sd">    This function detects skeleton edges that intersect the mesh boundary and</span>
</span><span id="fix_outside_edges-353"><a href="#fix_outside_edges-353"><span class="linenos">353</span></a><span class="sd">    fixes them by iteratively splitting crossing edges (inserting new vertices</span>
</span><span id="fix_outside_edges-354"><a href="#fix_outside_edges-354"><span class="linenos">354</span></a><span class="sd">    along the edge) and then recentering any vertices that end up outside the</span>
</span><span id="fix_outside_edges-355"><a href="#fix_outside_edges-355"><span class="linenos">355</span></a><span class="sd">    mesh using `recenter_vertices()`.</span>
</span><span id="fix_outside_edges-356"><a href="#fix_outside_edges-356"><span class="linenos">356</span></a>
</span><span id="fix_outside_edges-357"><a href="#fix_outside_edges-357"><span class="linenos">357</span></a><span class="sd">    Notes</span>
</span><span id="fix_outside_edges-358"><a href="#fix_outside_edges-358"><span class="linenos">358</span></a><span class="sd">    -----</span>
</span><span id="fix_outside_edges-359"><a href="#fix_outside_edges-359"><span class="linenos">359</span></a><span class="sd">    This will also modify original vertices positions (via `skeletor.post.recenter_vertices()`).</span>
</span><span id="fix_outside_edges-360"><a href="#fix_outside_edges-360"><span class="linenos">360</span></a><span class="sd">    Splitting edges inserts new skeleton nodes that are not represented in &quot;skel_map&quot;. Currently,</span>
</span><span id="fix_outside_edges-361"><a href="#fix_outside_edges-361"><span class="linenos">361</span></a><span class="sd">    we invalidate any existing &quot;mesh_map&quot; and &quot;skel_map&quot; (setting it to `None`). In the</span>
</span><span id="fix_outside_edges-362"><a href="#fix_outside_edges-362"><span class="linenos">362</span></a><span class="sd">    future, we may add functionality to update the mapping instead.</span>
</span><span id="fix_outside_edges-363"><a href="#fix_outside_edges-363"><span class="linenos">363</span></a>
</span><span id="fix_outside_edges-364"><a href="#fix_outside_edges-364"><span class="linenos">364</span></a><span class="sd">    Parameters</span>
</span><span id="fix_outside_edges-365"><a href="#fix_outside_edges-365"><span class="linenos">365</span></a><span class="sd">    ----------</span>
</span><span id="fix_outside_edges-366"><a href="#fix_outside_edges-366"><span class="linenos">366</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="fix_outside_edges-367"><a href="#fix_outside_edges-367"><span class="linenos">367</span></a><span class="sd">    mesh :      trimesh.Trimesh</span>
</span><span id="fix_outside_edges-368"><a href="#fix_outside_edges-368"><span class="linenos">368</span></a><span class="sd">                Original mesh. If mesh is None, will use the mesh associated with input</span>
</span><span id="fix_outside_edges-369"><a href="#fix_outside_edges-369"><span class="linenos">369</span></a><span class="sd">                skeleton (`s.mesh`).</span>
</span><span id="fix_outside_edges-370"><a href="#fix_outside_edges-370"><span class="linenos">370</span></a><span class="sd">    inplace :   bool</span>
</span><span id="fix_outside_edges-371"><a href="#fix_outside_edges-371"><span class="linenos">371</span></a><span class="sd">                If False will make and return a copy of the skeleton. If True,</span>
</span><span id="fix_outside_edges-372"><a href="#fix_outside_edges-372"><span class="linenos">372</span></a><span class="sd">                will modify the `s` inplace.</span>
</span><span id="fix_outside_edges-373"><a href="#fix_outside_edges-373"><span class="linenos">373</span></a><span class="sd">    max_iter :  int</span>
</span><span id="fix_outside_edges-374"><a href="#fix_outside_edges-374"><span class="linenos">374</span></a><span class="sd">                Max split iterations for boundary-crossing edges.</span>
</span><span id="fix_outside_edges-375"><a href="#fix_outside_edges-375"><span class="linenos">375</span></a><span class="sd">    smooth_iters : int</span>
</span><span id="fix_outside_edges-376"><a href="#fix_outside_edges-376"><span class="linenos">376</span></a><span class="sd">                Number of smoothing iterations for degree-2 chain nodes.</span>
</span><span id="fix_outside_edges-377"><a href="#fix_outside_edges-377"><span class="linenos">377</span></a><span class="sd">    eps :       float or {&#39;auto&#39;}</span>
</span><span id="fix_outside_edges-378"><a href="#fix_outside_edges-378"><span class="linenos">378</span></a><span class="sd">                Ignore intersections within eps of either endpoint.</span>
</span><span id="fix_outside_edges-379"><a href="#fix_outside_edges-379"><span class="linenos">379</span></a><span class="sd">                If &quot;auto&quot;, uses mesh mean unique edge length * 1e-4.</span>
</span><span id="fix_outside_edges-380"><a href="#fix_outside_edges-380"><span class="linenos">380</span></a>
</span><span id="fix_outside_edges-381"><a href="#fix_outside_edges-381"><span class="linenos">381</span></a><span class="sd">    Returns</span>
</span><span id="fix_outside_edges-382"><a href="#fix_outside_edges-382"><span class="linenos">382</span></a><span class="sd">    -------</span>
</span><span id="fix_outside_edges-383"><a href="#fix_outside_edges-383"><span class="linenos">383</span></a><span class="sd">    s :         skeletor.Skeleton</span>
</span><span id="fix_outside_edges-384"><a href="#fix_outside_edges-384"><span class="linenos">384</span></a>
</span><span id="fix_outside_edges-385"><a href="#fix_outside_edges-385"><span class="linenos">385</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="fix_outside_edges-386"><a href="#fix_outside_edges-386"><span class="linenos">386</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span><span id="fix_outside_edges-387"><a href="#fix_outside_edges-387"><span class="linenos">387</span></a>        <span class="n">mesh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="fix_outside_edges-388"><a href="#fix_outside_edges-388"><span class="linenos">388</span></a>
</span><span id="fix_outside_edges-389"><a href="#fix_outside_edges-389"><span class="linenos">389</span></a>    <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fix_outside_edges-390"><a href="#fix_outside_edges-390"><span class="linenos">390</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="fix_outside_edges-391"><a href="#fix_outside_edges-391"><span class="linenos">391</span></a>            <span class="s2">&quot;Mesh is required for fixing outside edges. Please provide a mesh or ensure `s.mesh` is set.&quot;</span>
</span><span id="fix_outside_edges-392"><a href="#fix_outside_edges-392"><span class="linenos">392</span></a>        <span class="p">)</span>
</span><span id="fix_outside_edges-393"><a href="#fix_outside_edges-393"><span class="linenos">393</span></a>
</span><span id="fix_outside_edges-394"><a href="#fix_outside_edges-394"><span class="linenos">394</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="fix_outside_edges-395"><a href="#fix_outside_edges-395"><span class="linenos">395</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="fix_outside_edges-396"><a href="#fix_outside_edges-396"><span class="linenos">396</span></a>
</span><span id="fix_outside_edges-397"><a href="#fix_outside_edges-397"><span class="linenos">397</span></a>    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="fix_outside_edges-398"><a href="#fix_outside_edges-398"><span class="linenos">398</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="fix_outside_edges-399"><a href="#fix_outside_edges-399"><span class="linenos">399</span></a>
</span><span id="fix_outside_edges-400"><a href="#fix_outside_edges-400"><span class="linenos">400</span></a>    <span class="c1"># Determine eps (scale-aware)</span>
</span><span id="fix_outside_edges-401"><a href="#fix_outside_edges-401"><span class="linenos">401</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="fix_outside_edges-402"><a href="#fix_outside_edges-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">eps</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="fix_outside_edges-403"><a href="#fix_outside_edges-403"><span class="linenos">403</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for `eps`. Must be a number or &#39;auto&#39;.&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-404"><a href="#fix_outside_edges-404"><span class="linenos">404</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fix_outside_edges-405"><a href="#fix_outside_edges-405"><span class="linenos">405</span></a>            <span class="n">mean_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">edges_unique_length</span><span class="p">))</span>
</span><span id="fix_outside_edges-406"><a href="#fix_outside_edges-406"><span class="linenos">406</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="fix_outside_edges-407"><a href="#fix_outside_edges-407"><span class="linenos">407</span></a>            <span class="n">mean_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="fix_outside_edges-408"><a href="#fix_outside_edges-408"><span class="linenos">408</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="fix_outside_edges-409"><a href="#fix_outside_edges-409"><span class="linenos">409</span></a>            <span class="n">mean_length</span> <span class="o">*</span> <span class="mf">1e-4</span>
</span><span id="fix_outside_edges-410"><a href="#fix_outside_edges-410"><span class="linenos">410</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mean_length</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mean_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="fix_outside_edges-411"><a href="#fix_outside_edges-411"><span class="linenos">411</span></a>            <span class="k">else</span> <span class="mf">1e-6</span>
</span><span id="fix_outside_edges-412"><a href="#fix_outside_edges-412"><span class="linenos">412</span></a>        <span class="p">)</span>
</span><span id="fix_outside_edges-413"><a href="#fix_outside_edges-413"><span class="linenos">413</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="fix_outside_edges-414"><a href="#fix_outside_edges-414"><span class="linenos">414</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
</span><span id="fix_outside_edges-415"><a href="#fix_outside_edges-415"><span class="linenos">415</span></a>
</span><span id="fix_outside_edges-416"><a href="#fix_outside_edges-416"><span class="linenos">416</span></a>    <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_iter</span><span class="p">)</span>
</span><span id="fix_outside_edges-417"><a href="#fix_outside_edges-417"><span class="linenos">417</span></a>    <span class="k">if</span> <span class="n">max_iter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fix_outside_edges-418"><a href="#fix_outside_edges-418"><span class="linenos">418</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`max_iter` must be &gt;= 0&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-419"><a href="#fix_outside_edges-419"><span class="linenos">419</span></a>
</span><span id="fix_outside_edges-420"><a href="#fix_outside_edges-420"><span class="linenos">420</span></a>    <span class="n">smooth_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">smooth_iters</span><span class="p">)</span>
</span><span id="fix_outside_edges-421"><a href="#fix_outside_edges-421"><span class="linenos">421</span></a>    <span class="k">if</span> <span class="n">smooth_iters</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fix_outside_edges-422"><a href="#fix_outside_edges-422"><span class="linenos">422</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`smooth_iters` must be &gt;= 0&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-423"><a href="#fix_outside_edges-423"><span class="linenos">423</span></a>
</span><span id="fix_outside_edges-424"><a href="#fix_outside_edges-424"><span class="linenos">424</span></a>    <span class="n">coll</span> <span class="o">=</span> <span class="n">ncollpyde</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="fix_outside_edges-425"><a href="#fix_outside_edges-425"><span class="linenos">425</span></a>
</span><span id="fix_outside_edges-426"><a href="#fix_outside_edges-426"><span class="linenos">426</span></a>    <span class="c1"># 1. Recenter any nodes outside the mesh</span>
</span><span id="fix_outside_edges-427"><a href="#fix_outside_edges-427"><span class="linenos">427</span></a>    <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vertices</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="fix_outside_edges-428"><a href="#fix_outside_edges-428"><span class="linenos">428</span></a>        <span class="n">recenter_vertices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="fix_outside_edges-429"><a href="#fix_outside_edges-429"><span class="linenos">429</span></a>
</span><span id="fix_outside_edges-430"><a href="#fix_outside_edges-430"><span class="linenos">430</span></a>    <span class="n">has_radius</span> <span class="o">=</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">columns</span>
</span><span id="fix_outside_edges-431"><a href="#fix_outside_edges-431"><span class="linenos">431</span></a>
</span><span id="fix_outside_edges-432"><a href="#fix_outside_edges-432"><span class="linenos">432</span></a>    <span class="c1"># 2. Iteratively split crossing edges</span>
</span><span id="fix_outside_edges-433"><a href="#fix_outside_edges-433"><span class="linenos">433</span></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
</span><span id="fix_outside_edges-434"><a href="#fix_outside_edges-434"><span class="linenos">434</span></a>        <span class="n">swc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span>
</span><span id="fix_outside_edges-435"><a href="#fix_outside_edges-435"><span class="linenos">435</span></a>        <span class="n">edge_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="fix_outside_edges-436"><a href="#fix_outside_edges-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">edge_rows</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fix_outside_edges-437"><a href="#fix_outside_edges-437"><span class="linenos">437</span></a>            <span class="k">break</span>
</span><span id="fix_outside_edges-438"><a href="#fix_outside_edges-438"><span class="linenos">438</span></a>
</span><span id="fix_outside_edges-439"><a href="#fix_outside_edges-439"><span class="linenos">439</span></a>        <span class="n">sources</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge_rows</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-440"><a href="#fix_outside_edges-440"><span class="linenos">440</span></a>        <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge_rows</span><span class="p">,</span> <span class="s2">&quot;parent_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-441"><a href="#fix_outside_edges-441"><span class="linenos">441</span></a>        <span class="n">targets</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parent_ids</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-442"><a href="#fix_outside_edges-442"><span class="linenos">442</span></a>
</span><span id="fix_outside_edges-443"><a href="#fix_outside_edges-443"><span class="linenos">443</span></a>        <span class="n">ix</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">intersections</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</span><span id="fix_outside_edges-444"><a href="#fix_outside_edges-444"><span class="linenos">444</span></a>
</span><span id="fix_outside_edges-445"><a href="#fix_outside_edges-445"><span class="linenos">445</span></a>        <span class="n">crossing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">edge_rows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="fix_outside_edges-446"><a href="#fix_outside_edges-446"><span class="linenos">446</span></a>
</span><span id="fix_outside_edges-447"><a href="#fix_outside_edges-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ix</span><span class="p">):</span>
</span><span id="fix_outside_edges-448"><a href="#fix_outside_edges-448"><span class="linenos">448</span></a>            <span class="n">d_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span> <span class="o">-</span> <span class="n">sources</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="fix_outside_edges-449"><a href="#fix_outside_edges-449"><span class="linenos">449</span></a>            <span class="n">d_tgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="fix_outside_edges-450"><a href="#fix_outside_edges-450"><span class="linenos">450</span></a>            <span class="n">real_crossings</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_src</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d_tgt</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span>
</span><span id="fix_outside_edges-451"><a href="#fix_outside_edges-451"><span class="linenos">451</span></a>            <span class="k">if</span> <span class="n">real_crossings</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="fix_outside_edges-452"><a href="#fix_outside_edges-452"><span class="linenos">452</span></a>                <span class="n">crossing</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ix</span><span class="p">[</span><span class="n">real_crossings</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="fix_outside_edges-453"><a href="#fix_outside_edges-453"><span class="linenos">453</span></a>
</span><span id="fix_outside_edges-454"><a href="#fix_outside_edges-454"><span class="linenos">454</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">crossing</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="fix_outside_edges-455"><a href="#fix_outside_edges-455"><span class="linenos">455</span></a>            <span class="k">break</span>
</span><span id="fix_outside_edges-456"><a href="#fix_outside_edges-456"><span class="linenos">456</span></a>
</span><span id="fix_outside_edges-457"><a href="#fix_outside_edges-457"><span class="linenos">457</span></a>        <span class="n">to_split</span> <span class="o">=</span> <span class="n">edge_rows</span><span class="p">[</span><span class="n">crossing</span><span class="p">]</span>
</span><span id="fix_outside_edges-458"><a href="#fix_outside_edges-458"><span class="linenos">458</span></a>        <span class="n">next_node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">swc</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="fix_outside_edges-459"><a href="#fix_outside_edges-459"><span class="linenos">459</span></a>
</span><span id="fix_outside_edges-460"><a href="#fix_outside_edges-460"><span class="linenos">460</span></a>        <span class="n">new_rows</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="fix_outside_edges-461"><a href="#fix_outside_edges-461"><span class="linenos">461</span></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-462"><a href="#fix_outside_edges-462"><span class="linenos">462</span></a>
</span><span id="fix_outside_edges-463"><a href="#fix_outside_edges-463"><span class="linenos">463</span></a>        <span class="c1"># Cache arrays for cheap positional access inside the loop</span>
</span><span id="fix_outside_edges-464"><a href="#fix_outside_edges-464"><span class="linenos">464</span></a>        <span class="n">parent_id_arr</span> <span class="o">=</span> <span class="n">swc</span><span class="p">[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="fix_outside_edges-465"><a href="#fix_outside_edges-465"><span class="linenos">465</span></a>        <span class="n">parent_col</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-466"><a href="#fix_outside_edges-466"><span class="linenos">466</span></a>
</span><span id="fix_outside_edges-467"><a href="#fix_outside_edges-467"><span class="linenos">467</span></a>        <span class="n">xyz_arr</span> <span class="o">=</span> <span class="n">swc</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="fix_outside_edges-468"><a href="#fix_outside_edges-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">xyz_arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
</span><span id="fix_outside_edges-469"><a href="#fix_outside_edges-469"><span class="linenos">469</span></a>            <span class="n">xyz_arr</span> <span class="o">=</span> <span class="n">xyz_arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span id="fix_outside_edges-470"><a href="#fix_outside_edges-470"><span class="linenos">470</span></a>
</span><span id="fix_outside_edges-471"><a href="#fix_outside_edges-471"><span class="linenos">471</span></a>        <span class="k">for</span> <span class="n">edge_row</span> <span class="ow">in</span> <span class="n">to_split</span><span class="p">:</span>
</span><span id="fix_outside_edges-472"><a href="#fix_outside_edges-472"><span class="linenos">472</span></a>            <span class="c1"># edge_row is a positional row index (from np.where)</span>
</span><span id="fix_outside_edges-473"><a href="#fix_outside_edges-473"><span class="linenos">473</span></a>            <span class="n">parent_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parent_id_arr</span><span class="p">[</span><span class="n">edge_row</span><span class="p">])</span>
</span><span id="fix_outside_edges-474"><a href="#fix_outside_edges-474"><span class="linenos">474</span></a>            <span class="k">if</span> <span class="n">parent_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fix_outside_edges-475"><a href="#fix_outside_edges-475"><span class="linenos">475</span></a>                <span class="k">continue</span>
</span><span id="fix_outside_edges-476"><a href="#fix_outside_edges-476"><span class="linenos">476</span></a>
</span><span id="fix_outside_edges-477"><a href="#fix_outside_edges-477"><span class="linenos">477</span></a>            <span class="c1"># Midpoint (no projection; recenter will handle)</span>
</span><span id="fix_outside_edges-478"><a href="#fix_outside_edges-478"><span class="linenos">478</span></a>            <span class="n">child_co</span> <span class="o">=</span> <span class="n">xyz_arr</span><span class="p">[</span><span class="n">edge_row</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="fix_outside_edges-479"><a href="#fix_outside_edges-479"><span class="linenos">479</span></a>            <span class="n">parent_co</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parent_id</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
</span><span id="fix_outside_edges-480"><a href="#fix_outside_edges-480"><span class="linenos">480</span></a>                <span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span>
</span><span id="fix_outside_edges-481"><a href="#fix_outside_edges-481"><span class="linenos">481</span></a>            <span class="p">)</span>
</span><span id="fix_outside_edges-482"><a href="#fix_outside_edges-482"><span class="linenos">482</span></a>            <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">child_co</span> <span class="o">+</span> <span class="n">parent_co</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="fix_outside_edges-483"><a href="#fix_outside_edges-483"><span class="linenos">483</span></a>
</span><span id="fix_outside_edges-484"><a href="#fix_outside_edges-484"><span class="linenos">484</span></a>            <span class="c1"># Rewire child -&gt; new node (positional write; avoids boolean mask on node_id)</span>
</span><span id="fix_outside_edges-485"><a href="#fix_outside_edges-485"><span class="linenos">485</span></a>            <span class="n">swc</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">edge_row</span><span class="p">,</span> <span class="n">parent_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_node_id</span>
</span><span id="fix_outside_edges-486"><a href="#fix_outside_edges-486"><span class="linenos">486</span></a>            <span class="n">parent_id_arr</span><span class="p">[</span><span class="n">edge_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_node_id</span>  <span class="c1"># keep cached view consistent</span>
</span><span id="fix_outside_edges-487"><a href="#fix_outside_edges-487"><span class="linenos">487</span></a>
</span><span id="fix_outside_edges-488"><a href="#fix_outside_edges-488"><span class="linenos">488</span></a>            <span class="c1"># Create new node row</span>
</span><span id="fix_outside_edges-489"><a href="#fix_outside_edges-489"><span class="linenos">489</span></a>            <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">swc</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
</span><span id="fix_outside_edges-490"><a href="#fix_outside_edges-490"><span class="linenos">490</span></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;node_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_node_id</span>
</span><span id="fix_outside_edges-491"><a href="#fix_outside_edges-491"><span class="linenos">491</span></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_id</span>
</span><span id="fix_outside_edges-492"><a href="#fix_outside_edges-492"><span class="linenos">492</span></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint</span>
</span><span id="fix_outside_edges-493"><a href="#fix_outside_edges-493"><span class="linenos">493</span></a>
</span><span id="fix_outside_edges-494"><a href="#fix_outside_edges-494"><span class="linenos">494</span></a>            <span class="k">if</span> <span class="n">has_radius</span><span class="p">:</span>
</span><span id="fix_outside_edges-495"><a href="#fix_outside_edges-495"><span class="linenos">495</span></a>                <span class="n">child_r</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span>
</span><span id="fix_outside_edges-496"><a href="#fix_outside_edges-496"><span class="linenos">496</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">swc</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_row</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">]]),</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
</span><span id="fix_outside_edges-497"><a href="#fix_outside_edges-497"><span class="linenos">497</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="fix_outside_edges-498"><a href="#fix_outside_edges-498"><span class="linenos">498</span></a>                <span class="n">parent_r</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span>
</span><span id="fix_outside_edges-499"><a href="#fix_outside_edges-499"><span class="linenos">499</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parent_id</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">]]),</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
</span><span id="fix_outside_edges-500"><a href="#fix_outside_edges-500"><span class="linenos">500</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="fix_outside_edges-501"><a href="#fix_outside_edges-501"><span class="linenos">501</span></a>                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">child_r</span><span class="p">,</span> <span class="n">parent_r</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
</span><span id="fix_outside_edges-502"><a href="#fix_outside_edges-502"><span class="linenos">502</span></a>
</span><span id="fix_outside_edges-503"><a href="#fix_outside_edges-503"><span class="linenos">503</span></a>            <span class="n">new_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="fix_outside_edges-504"><a href="#fix_outside_edges-504"><span class="linenos">504</span></a>            <span class="n">next_node_id</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="fix_outside_edges-505"><a href="#fix_outside_edges-505"><span class="linenos">505</span></a>
</span><span id="fix_outside_edges-506"><a href="#fix_outside_edges-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_rows</span><span class="p">:</span>
</span><span id="fix_outside_edges-507"><a href="#fix_outside_edges-507"><span class="linenos">507</span></a>            <span class="k">break</span>
</span><span id="fix_outside_edges-508"><a href="#fix_outside_edges-508"><span class="linenos">508</span></a>
</span><span id="fix_outside_edges-509"><a href="#fix_outside_edges-509"><span class="linenos">509</span></a>        <span class="n">swc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="fix_outside_edges-510"><a href="#fix_outside_edges-510"><span class="linenos">510</span></a>            <span class="p">[</span><span class="n">swc</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">swc</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
</span><span id="fix_outside_edges-511"><a href="#fix_outside_edges-511"><span class="linenos">511</span></a>        <span class="p">)</span>
</span><span id="fix_outside_edges-512"><a href="#fix_outside_edges-512"><span class="linenos">512</span></a>        <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">swc</span>
</span><span id="fix_outside_edges-513"><a href="#fix_outside_edges-513"><span class="linenos">513</span></a>
</span><span id="fix_outside_edges-514"><a href="#fix_outside_edges-514"><span class="linenos">514</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-515"><a href="#fix_outside_edges-515"><span class="linenos">515</span></a>        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="fix_outside_edges-516"><a href="#fix_outside_edges-516"><span class="linenos">516</span></a>            <span class="n">recenter_vertices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="fix_outside_edges-517"><a href="#fix_outside_edges-517"><span class="linenos">517</span></a>
</span><span id="fix_outside_edges-518"><a href="#fix_outside_edges-518"><span class="linenos">518</span></a>    <span class="c1"># 3. Smoothing (degree-2 chain nodes), then recenter</span>
</span><span id="fix_outside_edges-519"><a href="#fix_outside_edges-519"><span class="linenos">519</span></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">smooth_iters</span><span class="p">):</span>
</span><span id="fix_outside_edges-520"><a href="#fix_outside_edges-520"><span class="linenos">520</span></a>        <span class="n">swc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span>
</span><span id="fix_outside_edges-521"><a href="#fix_outside_edges-521"><span class="linenos">521</span></a>
</span><span id="fix_outside_edges-522"><a href="#fix_outside_edges-522"><span class="linenos">522</span></a>        <span class="n">child_counts</span> <span class="o">=</span> <span class="n">swc</span><span class="p">[</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span id="fix_outside_edges-523"><a href="#fix_outside_edges-523"><span class="linenos">523</span></a>        <span class="n">is_chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="fix_outside_edges-524"><a href="#fix_outside_edges-524"><span class="linenos">524</span></a>            <span class="n">swc</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">child_counts</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="fix_outside_edges-525"><a href="#fix_outside_edges-525"><span class="linenos">525</span></a>        <span class="p">)</span>
</span><span id="fix_outside_edges-526"><a href="#fix_outside_edges-526"><span class="linenos">526</span></a>        <span class="n">chain_nodes</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_chain</span><span class="p">,</span> <span class="s2">&quot;node_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="fix_outside_edges-527"><a href="#fix_outside_edges-527"><span class="linenos">527</span></a>
</span><span id="fix_outside_edges-528"><a href="#fix_outside_edges-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="n">chain_nodes</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fix_outside_edges-529"><a href="#fix_outside_edges-529"><span class="linenos">529</span></a>            <span class="k">break</span>
</span><span id="fix_outside_edges-530"><a href="#fix_outside_edges-530"><span class="linenos">530</span></a>
</span><span id="fix_outside_edges-531"><a href="#fix_outside_edges-531"><span class="linenos">531</span></a>        <span class="n">only_child</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="fix_outside_edges-532"><a href="#fix_outside_edges-532"><span class="linenos">532</span></a>            <span class="n">swc</span><span class="p">[</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="fix_outside_edges-533"><a href="#fix_outside_edges-533"><span class="linenos">533</span></a>        <span class="p">)</span>
</span><span id="fix_outside_edges-534"><a href="#fix_outside_edges-534"><span class="linenos">534</span></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-535"><a href="#fix_outside_edges-535"><span class="linenos">535</span></a>
</span><span id="fix_outside_edges-536"><a href="#fix_outside_edges-536"><span class="linenos">536</span></a>        <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chain_nodes</span><span class="p">,</span> <span class="s2">&quot;parent_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="fix_outside_edges-537"><a href="#fix_outside_edges-537"><span class="linenos">537</span></a>        <span class="n">child_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">only_child</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">chain_nodes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="fix_outside_edges-538"><a href="#fix_outside_edges-538"><span class="linenos">538</span></a>
</span><span id="fix_outside_edges-539"><a href="#fix_outside_edges-539"><span class="linenos">539</span></a>        <span class="n">parent_co</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parent_ids</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span id="fix_outside_edges-540"><a href="#fix_outside_edges-540"><span class="linenos">540</span></a>        <span class="n">child_co</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">child_ids</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span id="fix_outside_edges-541"><a href="#fix_outside_edges-541"><span class="linenos">541</span></a>        <span class="n">smoothed</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent_co</span> <span class="o">+</span> <span class="n">child_co</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="fix_outside_edges-542"><a href="#fix_outside_edges-542"><span class="linenos">542</span></a>
</span><span id="fix_outside_edges-543"><a href="#fix_outside_edges-543"><span class="linenos">543</span></a>        <span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_chain</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">smoothed</span>
</span><span id="fix_outside_edges-544"><a href="#fix_outside_edges-544"><span class="linenos">544</span></a>        <span class="n">s</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="n">swc</span>
</span><span id="fix_outside_edges-545"><a href="#fix_outside_edges-545"><span class="linenos">545</span></a>
</span><span id="fix_outside_edges-546"><a href="#fix_outside_edges-546"><span class="linenos">546</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-547"><a href="#fix_outside_edges-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">coll</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="fix_outside_edges-548"><a href="#fix_outside_edges-548"><span class="linenos">548</span></a>            <span class="n">recenter_vertices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="fix_outside_edges-549"><a href="#fix_outside_edges-549"><span class="linenos">549</span></a>
</span><span id="fix_outside_edges-550"><a href="#fix_outside_edges-550"><span class="linenos">550</span></a>    <span class="n">swc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">swc</span>
</span><span id="fix_outside_edges-551"><a href="#fix_outside_edges-551"><span class="linenos">551</span></a>    <span class="n">edge_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">swc</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="fix_outside_edges-552"><a href="#fix_outside_edges-552"><span class="linenos">552</span></a>    <span class="n">remaining_crossings</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="fix_outside_edges-553"><a href="#fix_outside_edges-553"><span class="linenos">553</span></a>    <span class="c1"># Detect crossing edges again for double-checking</span>
</span><span id="fix_outside_edges-554"><a href="#fix_outside_edges-554"><span class="linenos">554</span></a>    <span class="k">if</span> <span class="n">edge_rows</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span><span id="fix_outside_edges-555"><a href="#fix_outside_edges-555"><span class="linenos">555</span></a>        <span class="n">sources</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge_rows</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-556"><a href="#fix_outside_edges-556"><span class="linenos">556</span></a>        <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge_rows</span><span class="p">,</span> <span class="s2">&quot;parent_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-557"><a href="#fix_outside_edges-557"><span class="linenos">557</span></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="n">swc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span>
</span><span id="fix_outside_edges-558"><a href="#fix_outside_edges-558"><span class="linenos">558</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fix_outside_edges-559"><a href="#fix_outside_edges-559"><span class="linenos">559</span></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parent_ids</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="fix_outside_edges-560"><a href="#fix_outside_edges-560"><span class="linenos">560</span></a>            <span class="n">ix</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">intersections</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</span><span id="fix_outside_edges-561"><a href="#fix_outside_edges-561"><span class="linenos">561</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ix</span><span class="p">):</span>
</span><span id="fix_outside_edges-562"><a href="#fix_outside_edges-562"><span class="linenos">562</span></a>                <span class="n">d_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span> <span class="o">-</span> <span class="n">sources</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="fix_outside_edges-563"><a href="#fix_outside_edges-563"><span class="linenos">563</span></a>                <span class="n">d_tgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="fix_outside_edges-564"><a href="#fix_outside_edges-564"><span class="linenos">564</span></a>                <span class="n">real</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_src</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d_tgt</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span>
</span><span id="fix_outside_edges-565"><a href="#fix_outside_edges-565"><span class="linenos">565</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">real</span><span class="p">):</span>
</span><span id="fix_outside_edges-566"><a href="#fix_outside_edges-566"><span class="linenos">566</span></a>                    <span class="n">crossing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">edge_rows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="fix_outside_edges-567"><a href="#fix_outside_edges-567"><span class="linenos">567</span></a>                    <span class="n">crossing</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ix</span><span class="p">[</span><span class="n">real</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="fix_outside_edges-568"><a href="#fix_outside_edges-568"><span class="linenos">568</span></a>                    <span class="n">remaining_crossings</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">crossing</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="fix_outside_edges-569"><a href="#fix_outside_edges-569"><span class="linenos">569</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="fix_outside_edges-570"><a href="#fix_outside_edges-570"><span class="linenos">570</span></a>            <span class="n">remaining_crossings</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="fix_outside_edges-571"><a href="#fix_outside_edges-571"><span class="linenos">571</span></a>
</span><span id="fix_outside_edges-572"><a href="#fix_outside_edges-572"><span class="linenos">572</span></a>    <span class="k">if</span> <span class="n">remaining_crossings</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fix_outside_edges-573"><a href="#fix_outside_edges-573"><span class="linenos">573</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="fix_outside_edges-574"><a href="#fix_outside_edges-574"><span class="linenos">574</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_crossings</span><span class="si">}</span><span class="s2"> crossing edges remain after </span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="fix_outside_edges-575"><a href="#fix_outside_edges-575"><span class="linenos">575</span></a>            <span class="s2">&quot;fix iteration(s); returning best-effort result. Consider increasing &quot;</span>
</span><span id="fix_outside_edges-576"><a href="#fix_outside_edges-576"><span class="linenos">576</span></a>            <span class="s2">&quot;`max_iter`, adjusting `eps`, and/or running `post.clean_up` / &quot;</span>
</span><span id="fix_outside_edges-577"><a href="#fix_outside_edges-577"><span class="linenos">577</span></a>            <span class="s2">&quot;`post.remove_bristles` first. Also check mesh quality (e.g. non-watertight &quot;</span>
</span><span id="fix_outside_edges-578"><a href="#fix_outside_edges-578"><span class="linenos">578</span></a>            <span class="s2">&quot;or degenerate faces).&quot;</span><span class="p">,</span>
</span><span id="fix_outside_edges-579"><a href="#fix_outside_edges-579"><span class="linenos">579</span></a>            <span class="ne">RuntimeWarning</span><span class="p">,</span>
</span><span id="fix_outside_edges-580"><a href="#fix_outside_edges-580"><span class="linenos">580</span></a>        <span class="p">)</span>
</span><span id="fix_outside_edges-581"><a href="#fix_outside_edges-581"><span class="linenos">581</span></a>
</span><span id="fix_outside_edges-582"><a href="#fix_outside_edges-582"><span class="linenos">582</span></a>    <span class="c1"># Invalidate mesh_map</span>
</span><span id="fix_outside_edges-583"><a href="#fix_outside_edges-583"><span class="linenos">583</span></a>    <span class="n">s</span><span class="o">.</span><span class="n">mesh_map</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="fix_outside_edges-584"><a href="#fix_outside_edges-584"><span class="linenos">584</span></a>
</span><span id="fix_outside_edges-585"><a href="#fix_outside_edges-585"><span class="linenos">585</span></a>    <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Fix edges that cross outside the mesh boundary.</p>

<p>This function detects skeleton edges that intersect the mesh boundary and
fixes them by iteratively splitting crossing edges (inserting new vertices
along the edge) and then recentering any vertices that end up outside the
mesh using <code><a href="#recenter_vertices">recenter_vertices()</a></code>.</p>

<h6 id="notes">Notes</h6>

<p>This will also modify original vertices positions (via <code><a href="#recenter_vertices">skeletor.post.recenter_vertices()</a></code>).
Splitting edges inserts new skeleton nodes that are not represented in "skel_map". Currently,
we invalidate any existing "mesh_map" and "skel_map" (setting it to <code>None</code>). In the
future, we may add functionality to update the mapping instead.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><p><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):</p></li>
<li><p><strong>mesh</strong> (trimesh.Trimesh):
Original mesh. If mesh is None, will use the mesh associated with input
skeleton (<code>s.mesh</code>).</p></li>
<li><strong>inplace</strong> (bool):
If False will make and return a copy of the skeleton. If True,
will modify the <code>s</code> inplace.</li>
<li><strong>max_iter</strong> (int):
Max split iterations for boundary-crossing edges.</li>
<li><strong>smooth_iters</strong> (int):
Number of smoothing iterations for degree-2 chain nodes.</li>
<li><strong>eps</strong> (float or {'auto'}):
Ignore intersections within eps of either endpoint.
If "auto", uses mesh mean unique edge length * 1e-4.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (<a href="../skeletor.html#Skeleton">skeletor.Skeleton</a>):</li>
</ul>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>